<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invincible - Superhero Character Sheet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Nosifer&family=Metal+Mania&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }

    .hero-title {
      font-family: 'Metal Mania', cursive;
      text-shadow: 3px 3px 0px #000000, 6px 6px 10px rgba(0,0,0,0.8);
      letter-spacing: 3px;
    }

    .attribute-input { transition: all 0.2s ease; }
    .attribute-input:focus {
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .section-card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: 2px solid #475569;
    }

    .hero-header { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
    .calculated-field { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
    .opt-label { @apply text-sm font-semibold mb-1 block; }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800 text-white font-sans">
  <div class="container mx-auto p-6 max-w-6xl">
    <!-- Header -->
    <div class="hero-header rounded-lg p-6 mb-6 text-center">
      <h1 class="hero-title text-5xl font-bold mb-2">INVINCIBLE</h1>
      <h2 class="text-xl opacity-90">Superhero Character Sheet</h2>
    </div>

    <!-- Randomiser Options -->
    <div class="section-card rounded-lg p-4 mb-6">
      <details class="group">
        <summary class="cursor-pointer flex items-center justify-between">
          <span class="text-red-400 text-xl font-bold">Randomiser Options</span>
          <span class="text-slate-300 text-sm group-open:hidden">click to expand</span>
          <span class="text-slate-300 text-sm hidden group-open:inline">click to collapse</span>
        </summary>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="opt-label">Seed (optional)</label>
            <input id="randSeed" type="text" placeholder="e.g., INVINCIBLE-001"
                   class="w-full p-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
            <p class="text-xs text-slate-400 mt-1">Use the same seed to repeat results.</p>
          </div>
          <div>
            <label class="opt-label">Powers to roll</label>
            <input id="optPowers" type="number" min="1" max="6" value="3"
                   class="w-full p-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="opt-label">Talents to roll</label>
            <input id="optTalents" type="number" min="1" max="6" value="2"
                   class="w-full p-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="opt-label">Drawbacks to roll</label>
            <input id="optDrawbacks" type="number" min="0" max="5" value="1"
                   class="w-full p-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="opt-label">Gear items to roll</label>
            <input id="optGear" type="number" min="0" max="6" value="2"
                   class="w-full p-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
          </div>
          <div class="flex items-center gap-2">
            <input id="optPreserve" type="checkbox" class="h-5 w-5">
            <label for="optPreserve" class="text-sm">Preserve non-empty fields (only fill blanks)</label>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-3">
          <button onclick="importRandomTables()" class="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg font-semibold transition-colors">
            Import Random Tables (JSON)
          </button>
          <input type="file" id="randomTablesInput" accept=".json" class="hidden" onchange="handleRandomTablesImport(event)">
          <button onclick="downloadRandomSchema()" class="bg-slate-600 hover:bg-slate-700 px-4 py-2 rounded-lg font-semibold transition-colors">
            Download Schema
          </button>
        </div>
        <p class="text-xs text-slate-400 mt-3">
          Imported tables merge into defaults. Keys: heroNames, civilianNames, roles, powerSources, powers, talents, drawbacks, gear, occupations, personalities, appearances, drives, flaws, relationships.
        </p>
      </details>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Section I: Hero Identification -->
      <div class="section-card rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4 text-red-400">I. Hero Identification</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Hero Name</label>
            <input type="text" id="heroName" placeholder="e.g., ATOM EVE, REX SPLODE"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Civilian Name</label>
            <input type="text" id="civilianName" placeholder="e.g., SAMANTHA EVE WILKINS"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Role</label>
            <select id="role" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
              <option value="">Select Role</option>
              <option value="Blaster">Blaster</option>
              <option value="Brains">Brains</option>
              <option value="Brawn">Brawn</option>
              <option value="Controller">Controller</option>
              <option value="Defender">Defender</option>
              <option value="Leader">Leader</option>
              <option value="Striker">Striker</option>
              <option value="Wildcard">Wildcard</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Appearance</label>
            <textarea id="appearance" rows="3" placeholder="Describe your hero's appearance..."
                      class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">Reputation</label>
              <input type="number" id="reputation" min="0" max="12"
                     class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Karma</label>
              <input type="number" id="karma" min="0"
                     class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:border-red-400 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

      <!-- Section II: Attributes -->
      <div class="section-card rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4 text-red-400">II. Attributes (1-12)</h3>
        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">FIGHTING</label>
              <input type="number" id="fighting" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Physical</p>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">AGILITY</label>
              <input type="number" id="agility" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Physical</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">STRENGTH</label>
              <input type="number" id="strength" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Physical</p>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">REASON</label>
              <input type="number" id="reason" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Mental</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">INTUITION</label>
              <input type="number" id="intuition" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Mental</p>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">PRESENCE</label>
              <input type="number" id="presence" min="1" max="12" value="1"
                     class="attribute-input w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-blue-400 focus:outline-none">
              <p class="text-xs text-slate-400 mt-1">Mental</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Section III: Core Stats -->
      <div class="section-card rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4 text-red-400">III. Core Stats</h3>
        <div class="space-y-4">
          <div class="calculated-field rounded-lg p-4">
            <label class="block text-sm font-semibold mb-2">Base Slugfest Damage</label>
            <div id="baseDamage" class="text-2xl font-bold text-center">1</div>
            <p class="text-xs text-green-200 mt-1">= STRENGTH ÷ 2 (rounded up)</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="calculated-field rounded-lg p-4">
              <label class="block text-sm font-semibold mb-2">Max Health</label>
              <div id="maxHealth" class="text-xl font-bold text-center">2</div>
              <p class="text-xs text-green-200 mt-1">(F+A+S) ÷ 2</p>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Current Health</label>
              <input type="number" id="currentHealth" min="0" value="2"
                     class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-red-400 focus:outline-none">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="calculated-field rounded-lg p-4">
              <label class="block text-sm font-semibold mb-2">Max Resolve</label>
              <div id="maxResolve" class="text-xl font-bold text-center">2</div>
              <p class="text-xs text-green-200 mt-1">(R+I+P) ÷ 2</p>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">Current Resolve</label>
              <input type="number" id="currentResolve" min="0" value="2"
                     class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-xl font-bold focus:border-red-400 focus:outline-none">
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">Critical Injuries</label>
            <textarea id="criticalInjuries" rows="2" placeholder="List any critical injuries and penalties..."
                      class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none"></textarea>
          </div>
        </div>
      </div>

      <!-- Section IV: Personal Stuff -->
      <div class="section-card rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-4 text-red-400">IV. Personal Stuff</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold mb-2">Occupation</label>
            <input type="text" id="occupation" placeholder="Background, civilian life, or day job"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Personality</label>
            <input type="text" id="personality" placeholder="How others initially perceive the hero"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Drive</label>
            <input type="text" id="drive" placeholder="Why the hero exposes themselves to danger"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Flaw</label>
            <input type="text" id="flaw" placeholder="A weakness that causes trouble"
                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-2">Key Relationships</label>
            <textarea id="relationships" rows="3" placeholder="Family, friends, rivals who play large roles..."
                      class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Section V: Powers, Talents, and Drawbacks -->
    <div class="section-card rounded-lg p-6 mt-6">
      <h3 class="text-2xl font-bold mb-4 text-red-400">V. Powers, Talents, and Drawbacks</h3>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold mb-2">Power Source</label>
          <input type="text" id="powerSource" placeholder="e.g., Viltrumite Hybrid Physiology, Bioengineering"
                 class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none mb-4">

          <label class="block text-sm font-semibold mb-2">Powers</label>
          <textarea id="powers" rows="4" placeholder="List superhuman capabilities (BLAST, FLIGHT, PROTECTION, etc.)"
                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none mb-4"></textarea>

          <label class="block text-sm font-semibold mb-2">Talents</label>
          <textarea id="talents" rows="3" placeholder="Tricks, moves, minor abilities (DETERMINED, SUPPORTIVE, etc.)"
                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-2">Drawbacks</label>
          <textarea id="drawbacks" rows="4" placeholder="Limitations or vulnerabilities (ALTERNATE FORM, TARGETED, etc.)"
                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none mb-4"></textarea>

          <label class="block text-sm font-semibold mb-2">Resources</label>
          <input type="number" id="resources" min="0" placeholder="Standard of living score"
                 class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none mb-4">

          <label class="block text-sm font-semibold mb-2">Gear</label>
          <textarea id="gear" rows="3" placeholder="Equipment the hero possesses"
                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none resize-none mb-4"></textarea>

          <label class="block text-sm font-semibold mb-2">Team/Base</label>
          <input type="text" id="teamBase" placeholder="Organizational information"
                 class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-red-400 focus:outline-none">
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-4 mt-6 justify-center">
      <button onclick="clearSheet()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Clear Sheet
      </button>
      <button onclick="randomHero()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Generate Random Hero
      </button>
      <button onclick="importSheet()" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Import Character
      </button>
      <button onclick="exportSheet()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition-colors">
        Export Character
      </button>
    </div>

    <!-- Support Button -->
    <div class="text-center mt-8">
      <a href="https://ko-fi.com/boyzie" target="_blank" rel="noopener noreferrer"
         class="inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors opacity-80 hover:opacity-100">
        ☕ Buy me a coffee
      </a>
      <p class="text-xs text-slate-400 mt-2">Enjoying this character sheet? Support its development!</p>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" accept=".json" class="hidden" onchange="handleFileImport(event)">
  </div>

  <!-- Scripts -->
  <script>
    /* -------------------- Random Tables (Defaults) -------------------- 
       To import your own: prepare a JSON like:
       {
         "heroNames": ["Red Comet","Night Ember"],
         "civilianNames": ["Avery Kim","Dev Patel"],
         "roles": ["Blaster","Brains","..."],
         "powerSources": ["Alien lineage","Bioengineering","..."],
         "powers": ["Flight","Blast","Telekinesis","..."],
         "talents": ["Determined","Supportive","Tactician","..."],
         "drawbacks": ["Targeted","Code of Honour","Power Drain","..."],
         "gear": ["Communicator","Armoured suit","Grapple line","..."],
         "occupations": ["Paramedic","Journalist","AI researcher","..."],
         "personalities": ["Calm under pressure","Hot-headed but loyal","..."],
         "appearances": ["Sleek red-and-black suit with glowing sigils","..."],
         "drives": ["Protect the city that raised me","..."],
         "flaws": ["Impulsive risk-taker","..."],
         "relationships": ["Mentor at the agency","Estranged sibling","..."]
       }
    ------------------------------------------------------------------ */

    const defaultRandomTables = {
      heroNames: [
        "ATOM EVE","REX SPLODE","MONSTER GIRL","DUPLI-KATE","ROBOT","SHRINKING RAE",
        "Skybound Sentinel","Crimson Dynamo","Silver Warden","Arc Pulse","Volt Ranger",
        "Star Slinger","Night Aegis","Solaris Prime","Neon Valkyrie","Quantum Jack"
      ],
      civilianNames: [
        "SAMANTHA EVE WILKINS","REX SLOAN","AMANDA","KATE CHA","RUDOLPH CONNORS","RAE",
        "Avery Kim","Dev Patel","Maya Lopez","Jonah Sinclair","Priya Das","Liam Brooks",
        "Nadia Karim","Theo Shaw","Iris Bennett"
      ],
      roles: ["Blaster","Brains","Brawn","Controller","Defender","Leader","Striker","Wildcard"],
      powerSources: [
        "Viltrumite Hybrid Physiology","Bioengineering","Illicit Experiment","Robotic Automaton",
        "Genetic Mutation","Arcane Anomaly","Alien Relic Bond","Nano-augmented Physiology",
        "Dimensional Imprint"
      ],
      powers: [
        "Flight","Blast","Protection","Super Strength","Super Speed","Telekinesis","Telepathy",
        "Invisibility","Force Fields","Shapeshifting","Elasticity","Energy Absorption",
        "Regeneration","Matter Manipulation","Seismic Shock","Magnetism","Phasing","Gadgeteer"
      ],
      talents: [
        "Determined","Supportive","Tactician","Intimidating","Investigator","Acrobat",
        "Martial Artist","Field Medic","Pilot","Polyglot","Sharpshooter","Tech Savvy"
      ],
      drawbacks: [
        "Alternate Form","Targeted","Power Drain","Public Identity","Code of Honour",
        "Unstable Powers","Nemesis","Energy Dependency","Glass Jaw"
      ],
      gear: [
        "Communicator","Armoured Suit","Grapple Line","Multi-tool","Drone Scout",
        "First Aid Kit","Energy Bracers","Holo-Projector","Stealth Cloak","Tracking Beacons"
      ],
      occupations: [
        "Student","Forensic Analyst","Photojournalist","Paramedic","Teacher",
        "AI Researcher","Social Worker","Mechanic","Bartender","Pilot","Security Consultant"
      ],
      personalities: [
        "Calm under pressure","Hot-headed but loyal","Dry sense of humour","Stoic and observant",
        "Charismatic optimist","Brooding strategist","Reckless thrill-seeker","Compassionate mediator"
      ],
      appearances: [
        "Sleek red-and-black suit with glowing sigils",
        "Armoured plating over flexible nano-mesh",
        "Retro leather jacket with neon piping and visor",
        "Cloaked silhouette with mirrored mask",
        "Cerulean bodysuit with comet-trail motif",
        "Urban tactical gear with reinforced gauntlets"
      ],
      drives: [
        "Protect the city that raised me","Redeem a family legacy",
        "Expose corruption at any cost","Prove I deserve this power",
        "Keep my team safe","Avenge a fallen mentor"
      ],
      flaws: [
        "Impulsive risk-taker","Overconfident","Trust issues","Secretive to a fault",
        "Freezes when civilians are in danger","Reluctant to ask for help"
      ],
      relationships: [
        "Mentor at the agency","Estranged sibling","On-again off-again partner",
        "Rival hero who pushes you","Neighbour who suspects your identity",
        "Tech supplier who charges favours"
      ]
    };

    let randomTables = structuredClone(defaultRandomTables);

    /* -------------------- Storage -------------------- */
    function saveToLocalStorage() {
      const data = {};
      document.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.id) data[field.id] = field.value;
      });
      localStorage.setItem('invincible_character_sheet', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('invincible_character_sheet');
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        Object.keys(data).forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = data[id];
        });
        updateCalculatedStats();
      } catch (e) {
        console.log('Error loading saved data:', e);
      }
    }

    /* -------------------- Calculated stats -------------------- */
    function updateCalculatedStats() {
      const fighting = parseInt(document.getElementById('fighting').value) || 1;
      const agility = parseInt(document.getElementById('agility').value) || 1;
      const strength = parseInt(document.getElementById('strength').value) || 1;
      const reason = parseInt(document.getElementById('reason').value) || 1;
      const intuition = parseInt(document.getElementById('intuition').value) || 1;
      const presence = parseInt(document.getElementById('presence').value) || 1;

      const baseDamage = Math.ceil(strength / 2);
      document.getElementById('baseDamage').textContent = baseDamage;

      const maxHealth = Math.ceil((fighting + agility + strength) / 2);
      document.getElementById('maxHealth').textContent = maxHealth;

      const currentHealthField = document.getElementById('currentHealth');
      if (!currentHealthField.value || parseInt(currentHealthField.value) === parseInt(document.getElementById('maxHealth').textContent)) {
        currentHealthField.value = maxHealth;
      }

      const maxResolve = Math.ceil((reason + intuition + presence) / 2);
      document.getElementById('maxResolve').textContent = maxResolve;

      const currentResolveField = document.getElementById('currentResolve');
      if (!currentResolveField.value || parseInt(currentResolveField.value) === parseInt(document.getElementById('maxResolve').textContent)) {
        currentResolveField.value = maxResolve;
      }
    }

    /* -------------------- Helpers: RNG & picking -------------------- */
    function xmur3(str) {
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
      };
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function getRNG(seed) {
      if (!seed) return Math.random;
      const seedFn = xmur3(seed);
      return mulberry32(seedFn());
    }
    function pickOne(arr, rng = Math.random) {
      if (!arr || arr.length === 0) return "";
      return arr[Math.floor(rng() * arr.length)];
    }
    function pickMany(arr, n, rng = Math.random) {
      if (!arr || arr.length === 0) return [];
      const copy = [...arr];
      const out = [];
      for (let i = 0; i < n && copy.length; i++) {
        const idx = Math.floor(rng() * copy.length);
        out.push(copy.splice(idx, 1)[0]);
      }
      return out;
    }
    // 2d6-like distribution clamped to [min,max]
    function rollAttribute(rng, min = 1, max = 12) {
      const d = Math.floor(rng() * 6) + 1 + Math.floor(rng() * 6) + 1; // 2–12
      return Math.min(max, Math.max(min, d));
    }

    function fillIfAllowed(id, value, preserve) {
      const el = document.getElementById(id);
      if (!el) return;
      if (preserve && el.value && String(el.value).trim().length > 0) return;
      el.value = value;
    }

    /* -------------------- Actions -------------------- */
    function clearSheet() {
      if (!confirm('Are you sure you want to clear the entire character sheet? This will also delete your saved data.')) return;
      document.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.type === 'number' && ['fighting','agility','strength','reason','intuition','presence'].includes(field.id)) {
          field.value = 1;
        } else {
          field.value = '';
        }
      });
      updateCalculatedStats();
      localStorage.removeItem('invincible_character_sheet');
    }

    function randomHero() {
      const seed = document.getElementById('randSeed').value.trim();
      const rng = getRNG(seed || null);
      const preserve = document.getElementById('optPreserve').checked;

      const powersN = Math.max(1, parseInt(document.getElementById('optPowers').value) || 3);
      const talentsN = Math.max(1, parseInt(document.getElementById('optTalents').value) || 2);
      const drawbacksN = Math.max(0, parseInt(document.getElementById('optDrawbacks').value) || 1);
      const gearN = Math.max(0, parseInt(document.getElementById('optGear').value) || 2);

      // Names / Role / Source / Appearance / Personal
      fillIfAllowed('heroName',        pickOne(randomTables.heroNames, rng), preserve);
      fillIfAllowed('civilianName',    pickOne(randomTables.civilianNames, rng), preserve);
      const role = pickOne(randomTables.roles, rng);
      const roleEl = document.getElementById('role');
      if (!(preserve && roleEl.value)) roleEl.value = role;

      fillIfAllowed('powerSource',     pickOne(randomTables.powerSources, rng), preserve);
      fillIfAllowed('appearance',      pickOne(randomTables.appearances, rng), preserve);
      fillIfAllowed('occupation',      pickOne(randomTables.occupations, rng), preserve);
      fillIfAllowed('personality',     pickOne(randomTables.personalities, rng), preserve);
      fillIfAllowed('drive',           pickOne(randomTables.drives, rng), preserve);
      fillIfAllowed('flaw',            pickOne(randomTables.flaws, rng), preserve);
      fillIfAllowed('relationships',   pickMany(randomTables.relationships, 2, rng).join(', '), preserve);

      // Lists: powers/talents/drawbacks/gear
      fillIfAllowed('powers',   pickMany(randomTables.powers, powersN, rng).join(', '), preserve);
      fillIfAllowed('talents',  pickMany(randomTables.talents, talentsN, rng).join(', '), preserve);
      if (drawbacksN > 0) fillIfAllowed('drawbacks', pickMany(randomTables.drawbacks, drawbacksN, rng).join(', '), preserve);
      if (gearN > 0) fillIfAllowed('gear', pickMany(randomTables.gear, gearN, rng).join(', '), preserve);

      // Attributes: slightly bell-curved, clamped 1–12
      ['fighting','agility','strength','reason','intuition','presence'].forEach(attr => {
        const el = document.getElementById(attr);
        if (preserve && el.value && String(el.value).trim().length > 0) return;
        el.value = rollAttribute(rng, 1, 12);
      });

      // Other numeric bits
      fillIfAllowed('reputation', Math.floor(rng() * 6), preserve); // 0–5
      fillIfAllowed('karma',      Math.floor(rng() * 16) + 1, preserve); // 1–16
      fillIfAllowed('resources',  Math.floor(rng() * 6), preserve); // 0–5

      updateCalculatedStats();
      saveToLocalStorage();
    }

    function importSheet() {
      document.getElementById('fileInput').click();
    }

    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (!file.name.endsWith('.json')) {
        alert('Please select a valid JSON file.');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          Object.keys(data).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = data[id] ?? '';
          });
          updateCalculatedStats();
          saveToLocalStorage();

          const heroName = data.heroName || 'Imported Hero';
          alert(`Successfully imported character: ${heroName}`);
        } catch (error) {
          console.error('Import error:', error);
          alert('Error reading file. Please make sure it is a valid character sheet JSON file.');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportSheet() {
      try {
        const data = {};
        document.querySelectorAll('input, textarea, select').forEach(el => {
          if (el.id && el.id !== 'fileInput') data[el.id] = el.value;
        });

        const json = JSON.stringify(data, null, 2);
        const heroName = (data.heroName || 'Unnamed Hero').trim();
        const filename = `${heroName.replace(/[^\w\-]+/g, '_')}_character_sheet.json`;
        const blob = new Blob([json], { type: 'application/json' });

        // Legacy Edge and IE
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveOrOpenBlob(blob, filename);
          alert(`Character "${heroName}" exported successfully!`);
          return;
        }

        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;

        const downloadSupported = typeof a.download !== 'undefined';
        if (!downloadSupported) {
          window.open('data:application/json;charset=utf-8,' + encodeURIComponent(json), '_blank');
        } else {
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 0);
        }

        alert(`Character "${heroName}" exported successfully!`);
      } catch (err) {
        console.error('Export error:', err);
        alert('Export failed. See console for details.');
      }
    }

    /* -------------------- Random Table Import/Schema -------------------- */
    function importRandomTables() {
      document.getElementById('randomTablesInput').click();
    }
    function handleRandomTablesImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          // Merge arrays by key; ignore unknown keys
          Object.keys(data).forEach(k => {
            if (Array.isArray(data[k]) && Array.isArray(randomTables[k])) {
              randomTables[k] = [...randomTables[k], ...data[k]];
            }
          });
          alert('Random tables imported and merged successfully.');
        } catch (err) {
          console.error('Random table import error:', err);
          alert('Failed to import random tables. Ensure it is valid JSON.');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    function downloadRandomSchema() {
      const schema = {
        heroNames: ["Example Hero"],
        civilianNames: ["Example Civilian"],
        roles: ["Blaster","Brains"],
        powerSources: ["Alien lineage"],
        powers: ["Flight","Blast"],
        talents: ["Determined","Tactician"],
        drawbacks: ["Targeted"],
        gear: ["Communicator"],
        occupations: ["Journalist"],
        personalities: ["Calm under pressure"],
        appearances: ["Sleek red-and-black suit with glowing sigils"],
        drives: ["Protect the city that raised me"],
        flaws: ["Impulsive risk-taker"],
        relationships: ["Mentor at the agency"]
      };
      const blob = new Blob([JSON.stringify(schema, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'random_tables_schema.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    // Expose for inline handlers
    Object.assign(window, {
      saveToLocalStorage,
      loadFromLocalStorage,
      updateCalculatedStats,
      clearSheet,
      randomHero,
      importSheet,
      handleFileImport,
      exportSheet,
      importRandomTables,
      handleRandomTablesImport,
      downloadRandomSchema
    });

    // Init
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('input, textarea, select').forEach(field => {
        if (!field.id) return;
        field.addEventListener('input', () => {
          if (['fighting','agility','strength','reason','intuition','presence'].includes(field.id)) {
            updateCalculatedStats();
          }
          saveToLocalStorage();
        });
      });
      loadFromLocalStorage();
      updateCalculatedStats();
    });
  </script>
</body>
</html>
