<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Rampant Army Builder</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');
        
        body {
            font-family: 'Lato', sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            margin: 0;
        }
        
        h1, h2, h3, .fantasy-font {
            font-family: 'Cinzel', serif;
        }

        .stat-box {
            background-color: #262626;
            border: 1px solid #404040;
        }

        .parchment {
            background-color: #f3f0e6;
            color: #1a1a1a;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666; 
        }

        @media print {
            body {
                background-color: white;
                color: black;
            }
            .no-print {
                display: none !important;
            }
            .card-print {
                border: 1px solid #ccc;
                break-inside: avoid;
                margin-bottom: 1rem;
                background-color: white !important;
                color: black !important;
            }
            .text-amber-500,
            .text-amber-400,
            .text-amber-300 {
                color: #000 !important;
            }
            .bg-stone-900,
            .bg-stone-800,
            .bg-stone-950 {
                background-color: #fff !important;
                border-color: #000 !important;
            }
            .text-stone-300,
            .text-stone-400,
            .text-stone-500,
            .text-stone-200 {
                color: #333 !important;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="color:white; padding:1rem; font-family:sans-serif;">
            If you only see this message and nothing else, JavaScript or the CDNs have not loaded.
            Try opening this file in Chrome or another browser with an internet connection.
        </div>
    </div>

    <!-- Main app -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect } = React;

        // --- DATA: Unit Profiles ---
        const UNIT_TEMPLATES = [
            { name: "Elite Riders", sp: 6, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "7+", moveDist: '10"', armor: 4, defense: "5+", courage: "3+", rules: ["Wild Charge", "Counter-Charge"] },
            { name: "Heavy Riders", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '10"', armor: 3, defense: "5+", courage: "4+", rules: ["Counter-Charge"] },
            { name: "Light Riders", sp: 6, cost: 4, attackOrder: "7+", attackVal: "5+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '12"', armor: 3, defense: "6+", courage: "5+", rules: ["Skirmish", "Evade"] },
            { name: "Greater Warbeasts", sp: 6, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '10"', armor: 4, defense: "6+", courage: "3+", rules: ["Ranger", "Wild Charge", "Stomper"] },
            { name: "Lesser Warbeasts", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '12"', armor: 3, defense: "6+", courage: "4+", rules: ["Ranger", "Wild Charge", "Fleet Footed"] },
            { name: "Elite Foot", sp: 12, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 4, defense: "5+", courage: "3+", rules: ["Wild Charge"] },
            { name: "Heavy Foot", sp: 12, cost: 4, attackOrder: "6+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 3, defense: "5+", courage: "4+", rules: ["Wall of Spears"] },
            { name: "Light Foot", sp: 12, cost: 3, attackOrder: "6+", attackVal: "5+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '8"', armor: 2, defense: "5+", courage: "4+", rules: ["Offensive", "Wall of Spears"] }, 
            { name: "Bellicose Foot", sp: 12, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 2, defense: "6+", courage: "3+", rules: ["Wild Charge", "Counter-Charge"] },
            { name: "Heavy Missiles", sp: 12, cost: 4, attackOrder: "7+", attackVal: "5+", shootOrder: "6+", shootVal: "4+ / 18\"", moveOrder: "6+", moveDist: '6"', armor: 3, defense: "6+", courage: "4+", rules: [] },
            { name: "Light Missiles", sp: 12, cost: 4, attackOrder: "7+", attackVal: "6+", shootOrder: "6+", shootVal: "5+ / 18\"", moveOrder: "5+", moveDist: '8"', armor: 2, defense: "6+", courage: "4+", rules: ["Skirmish", "Evade"] },
            { name: "Scouts", sp: 6, cost: 2, attackOrder: "7+", attackVal: "6+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '8"', armor: 1, defense: "6+", courage: "5+", rules: ["Skirmish", "Evade"] },
            { name: "Ravenous Hordes", sp: 12, cost: 1, attackOrder: "6+", attackVal: "6+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 1, defense: "6+", courage: "5+", rules: ["Wild Charge"] },
            { name: "Chariots", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '8"', armor: 3, defense: "6+", courage: "4+", rules: ["Linear"] },
            { name: "Beserkers", sp: 6, cost: 4, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '8"', armor: 2, defense: "6+", courage: "3+", rules: ["Wild Charge", "Beserk"] }
        ];

        // --- DATA: Fantastical Rules & Upgrades (including Leader traits) ---
        const UPGRADES_LIST = [
            // Leader traits
            {
                name: "Brutal (L)",
                cost: 1,
                desc: "Leader trait: friendly units near this Leader can push themselves harder when rallying."
            },
            {
                name: "Divine Leadership (L)",
                cost: 2,
                desc: "Leader trait: greatly extends the Leader’s influence range for rerolls and Courage."
            },
            {
                name: "Insipid (L)",
                cost: -1,
                desc: "Leader trait: this Leader gives no Courage bonus; the unit is cheaper as a result."
            },
            {
                name: "Unstoppable March of the Dead (L)",
                cost: 3,
                desc: "Leader trait: only for fully Undead warbands; represents relentless undead advance."
            },
            {
                name: "Wise Old Owl (L)",
                cost: 1,
                desc: "Leader trait: gives a small edge when deciding attacker/defender."
            },

            // Standard Fantastical upgrades
            { name: "18/100 Strength*", cost: 4, desc: "Dramatic one-off boost to hitting power; great for a key combat." },
            { name: "Amphibious", cost: 1, desc: "Moves through water as if it were open ground." },
            { name: "Armor-Piercing", cost: 1, desc: "Attacks are especially good at punching through armour." },
            { name: "Beserk", cost: 1, desc: "Gains extra ferocity when charging into combat." },
            { name: "Blessed Blades*", cost: 4, desc: "Superb enchanted weapons; much more reliable in melee." },
            { name: "Brave", cost: 1, desc: "More reliable under fire or in frightening situations." },
            { name: "Burrower", cost: 1, desc: "Can emerge unexpectedly from underground positions." },
            { name: "Chariot", cost: 1, desc: "Heavy Riders upgrade; adds a short-ranged shooting attack." },
            { name: "Cleric", cost: 1, desc: "Can restore a small amount of lost Strength to allies." },
            { name: "Cowardly", cost: -1, desc: "More likely to fall back; cheaper but less dependable." },
            { name: "Cunning", cost: 1, desc: "Once per turn, can retry a failed Move or Attack test." },
            { name: "Cursed", cost: -1, desc: "Suffers a little extra damage each time it is hurt." },
            { name: "Enchanted Weapons", cost: 1, desc: "Attacks are slightly more accurate in melee." },
            { name: "Fear", cost: 1, desc: "Nearby enemies find it harder to stand their ground." },
            { name: "Fearful", cost: -1, desc: "More timid in the face of danger, but cheaper to field." },
            { name: "Fleet Footed", cost: 1, desc: "Moves faster than normal for its type." },
            { name: "Flying", cost: 2, desc: "Ignores terrain and units when moving; counts as a flyer." },
            { name: "Hatred", cost: 1, desc: "Particularly dangerous against one chosen enemy type." },
            { name: "Heavy Missiles", cost: 1, desc: "Extends missile range and punch." },
            { name: "Holy", cost: 1, desc: "Much less affected by fear- or terror-based effects." },
            { name: "Hunter", cost: 1, desc: "Comfortable shooting in rough or awkward terrain." },
            { name: "Invisibility", cost: 2, desc: "Hard to target at long range with shooting." },
            { name: "Magic Missiles", cost: 3, desc: "Extra dice when using ranged magical attacks." },
            { name: "Mystical Armor", cost: 2, desc: "Sometimes shrugs off damage entirely." },
            { name: "Offensive", cost: 1, desc: "More attacks in melee than usual." },
            { name: "Pikes", cost: 1, desc: "Blunts the advantages of mounted units charging it." },
            { name: "Poison", cost: 2, desc: "Occasional hits count extra due to venom or toxins." },
            { name: "Ponderous", cost: 1, desc: "Cannot charge or run; very deliberate movement." },
            { name: "Ranger", cost: 1, desc: "Moves easily through woods and other rough ground." },
            { name: "Regeneration", cost: 3, desc: "Can spend actions recovering lost Strength." },
            { name: "Scary", cost: 1, desc: "Harder for nearby foes to pass Courage tests." },
            { name: "Sharpshooter", cost: 2, desc: "More accurate when shooting at range." },
            { name: "Shieldwall", cost: 1, desc: "Better protected against shooting attacks." },
            { name: "Short Range Missiles", cost: 1, desc: "Missile range is shorter but still useful in close." },
            { name: "Single Entity", cost: 0, desc: "Represented by a single formidable model; fewer SP but tougher." },
            { name: "Skirmisher", cost: 1, desc: "More resilient to shooting and magic while harassing." },
            { name: "Slow", cost: -1, desc: "Reduced movement speed, but cheaper overall." },
            // Spellcaster levels – special handling in UI
            { name: "Spellcaster Lv1", cost: 1, desc: "Knows one colour of magic from the Spellbook." },
            { name: "Spellcaster Lv2", cost: 2, desc: "Knows two colours of magic from the Spellbook." },
            { name: "Spellcaster Lv3", cost: 3, desc: "Knows three colours of magic from the Spellbook." },
            { name: "Spellcaster Lv4", cost: 4, desc: "Knows four colours of magic from the Spellbook." },
            { name: "Spellcaster Lv1 (old)", cost: 1, desc: "Legacy entry; treat as Spellcaster Lv1 if seen in old JSON." }, // safety if you had older names – optional
            { name: "Spellcaster Lv2 (old)", cost: 2, desc: "Legacy entry; treat as Spellcaster Lv2 if seen in old JSON." },
            { name: "Spellcaster Lv3 (old)", cost: 3, desc: "Legacy entry; treat as Spellcaster Lv3 if seen in old JSON." },
            { name: "Spellcaster Lv1*", cost: 1, desc: "Legacy alt-name (if any older lists used it)." },
            { name: "Spellcaster Lv2*", cost: 2, desc: "Legacy alt-name (if any older lists used it)." },
            { name: "Spellcaster Lv3*", cost: 3, desc: "Legacy alt-name (if any older lists used it)." },
            { name: "Stout", cost: 1, desc: "Shrugs off the first hit it suffers each turn." },
            { name: "Summoner", cost: 3, desc: "Can bring in extra units mid-battle from reserves." },
            { name: "Terrific", cost: 2, desc: "Extremely frightening; enemies struggle with Courage tests." },
            { name: "Undead", cost: 1, desc: "Does not behave like normal troops when it suffers losses." },
            { name: "Venemous", cost: 3, desc: "Some attacks inflict extra damage when the venom bites." },
            { name: "Wall of Spears", cost: 1, desc: "Good at receiving charges; strikes first in many cases." },
            { name: "Weak", cost: -1, desc: "Its attacks usually inflict slightly fewer hits." },
            { name: "Weighty Projectiles", cost: 1, desc: "Missiles are especially good at cracking armour." },
            { name: "Well Led", cost: 1, desc: "Leader effect is a little stronger than normal." },
            { name: "Were-Creature", cost: 2, desc: "Can change form and fighting style during the game." },
            { name: "Wild", cost: -1, desc: "Unpredictable; sometimes charges the nearest foe instead of obeying orders." }
        ].filter((u, index, self) =>
            index === self.findIndex(v => v.name === u.name)
        ).sort((a, b) => a.name.localeCompare(b.name));

        const LEADER_UPGRADE_SUFFIX = "(L)";
        const UNSTOPPABLE_NAME = "Unstoppable March of the Dead (L)";

        // --- DATA: Spellbook (colours & spells) ---
        const SPELLBOOK = {
            Amber: [
                { name: "Almighty Prod! (6+)", summary: "Target: Friendly unit within 18".
    ◦ Effect: If the unit fails an ordered activation roll, it may immediately reroll it once. The spell ends immediately after use" },
                { name: "Be Brave!", summary: "Friendly unit rerolls failed Courage checks for a short time." }
            ],
            Crimson: [
                { name: "Take That You Rotter!", summary: "Magical ranged attack; works much like a short-ranged Shoot action." },
                { name: "Utter Chaos!", summary: "Target becomes unpredictable, acting under a chaotic rule for a turn." }
            ],
            Emerald: [
                { name: "Heal Thee!", summary: "Restore one or two lost Strength Points to a friendly unit in range." },
                { name: "Sod-Off Spell!", summary: "Cancels one Spell currently affecting the chosen unit." }
            ],
            Indigo: [
                { name: "Superglue You!", summary: "Pins the target in place so it cannot move, even when retreating." },
                { name: "You Shall Not Pass!", summary: "Creates a temporary barrier that blocks movement and line of sight." }
            ],
            Jade: [
                { name: "Bog Thee!", summary: "Makes the ground around the target count as rough terrain for a while." },
                { name: "Spring Heeled!", summary: "Friendly unit moves through rough ground at full speed for a short time." },
                { name: "You Have Wings!", summary: "Grants the Flyer rule briefly to the chosen unit." }
            ],
            Magenta: [
                { name: "Sharp Blades!", summary: "Friendly unit rerolls its failed Attack or Defence dice for a turn." },
                { name: "Sharp Darts!", summary: "Friendly unit rerolls failed Shooting dice for a turn." },
                { name: "Stronger Shields!", summary: "Temporarily increases the unit’s Armour value by one." }
            ],
            Saffron: [
                { name: "Dragon’s Breath!", summary: "Creates a drifting cloud that stops shooting in or through the target." },
                { name: "Go Wild!", summary: "Gives a unit the Berserk rule for a brief window, even when weakened." }
            ],
            Turquoise: [
                { name: "Teleport Thee!", summary: "Relocates one friendly unit a short distance without using its activation." },
                { name: "Transpose Thee!", summary: "Swaps the positions of two nearby units, friend or foe." }
            ],
            Violet: [
                { name: "Befuddle Thee!", summary: "Automatically batters one enemy unit unless they are already broken or Undead." },
                { name: "Curse Thee!", summary: "Gives the target the Cursed rule for a short time, making damage worse." }
            ]
        };

        const SPELL_COLOURS = Object.keys(SPELLBOOK);

        // --- Helpers for Spellcaster handling ---
        const SPELL_UPGRADE_NAMES = [
            "Spellcaster Lv1",
            "Spellcaster Lv2",
            "Spellcaster Lv3",
            "Spellcaster Lv4",
            "Spellcaster Lv1 (old)",
            "Spellcaster Lv2 (old)",
            "Spellcaster Lv3 (old)",
            "Spellcaster Lv1*",
            "Spellcaster Lv2*",
            "Spellcaster Lv3*"
        ];

        function getSpellcasterLevel(unit) {
            const names = (unit.selectedUpgrades || []).map(u => u.name);
            if (names.includes("Spellcaster Lv4")) return 4;
            if (names.includes("Spellcaster Lv3") || names.includes("Spellcaster Lv3*") || names.includes("Spellcaster Lv3 (old)")) return 3;
            if (names.includes("Spellcaster Lv2") || names.includes("Spellcaster Lv2*") || names.includes("Spellcaster Lv2 (old)")) return 2;
            if (names.includes("Spellcaster Lv1") || names.includes("Spellcaster Lv1*") || names.includes("Spellcaster Lv1 (old)")) return 1;
            return 0;
        }

        function normalizeSpellConfig(raw) {
            if (!raw || typeof raw !== "object") {
                return { colours: [], selectedSpells: [] };
            }
            const colours = Array.isArray(raw.colours) ? raw.colours.filter(c => SPELL_COLOURS.includes(c)) : [];
            const selectedSpells = Array.isArray(raw.selectedSpells)
                ? raw.selectedSpells
                    .filter(s => s && s.name && s.colour && SPELL_COLOURS.includes(s.colour))
                    .map(s => ({ name: s.name, colour: s.colour }))
                : [];
            return { colours, selectedSpells };
        }

        // Icon wrapper
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i className={`ph ph-${name} ${className}`} style={{ fontSize: size }}></i>;
        };

        const UnitCard = ({ unit, onUpdate, onDelete, onDuplicate, onSetLeader }) => {
            const handleNameChange = (e) => {
                onUpdate(unit.id, { ...unit, customName: e.target.value });
            };

            const addUpgrade = (e) => {
                const upgradeName = e.target.value;
                if (!upgradeName) return;
                
                const upgradeObj = UPGRADES_LIST.find(u => u.name === upgradeName);
                const currentUpgrades = unit.selectedUpgrades || [];

                // Prevent stacking multiple Spellcaster levels accidentally – keep all but this is safer
                const isSpellUpgrade = SPELL_UPGRADE_NAMES.includes(upgradeName);
                let newUpgrades = currentUpgrades.slice();

                if (isSpellUpgrade) {
                    // Remove any existing spellcaster levels, then add the chosen one
                    newUpgrades = currentUpgrades.filter(u => !SPELL_UPGRADE_NAMES.includes(u.name));
                    if (!newUpgrades.some(u => u.name === upgradeName) && upgradeObj) {
                        newUpgrades.push(upgradeObj);
                    }
                } else {
                    if (!currentUpgrades.some(u => u.name === upgradeName) && upgradeObj) {
                        newUpgrades = [...currentUpgrades, upgradeObj];
                    }
                }

                onUpdate(unit.id, { 
                    ...unit, 
                    selectedUpgrades: newUpgrades 
                });

                e.target.value = "";
            };

            const removeUpgrade = (upgradeName) => {
                onUpdate(unit.id, {
                    ...unit,
                    selectedUpgrades: (unit.selectedUpgrades || []).filter(u => u.name !== upgradeName)
                });
            };

            const totalCost = Math.max(
                0,
                unit.cost + (unit.selectedUpgrades || []).reduce((sum, u) => sum + u.cost, 0)
            );

            const cardClasses =
                "border rounded-lg p-4 mb-4 shadow-lg card-print relative " +
                (unit.isLeader
                    ? "bg-stone-900 border-amber-500 ring-1 ring-amber-500/60"
                    : "bg-stone-900 border-stone-700");

            const hasLeaderUpgradeOnNonLeader =
                !unit.isLeader &&
                (unit.selectedUpgrades || []).some(up => up.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1);

            const spellLevel = getSpellcasterLevel(unit);
            const spellConfig = normalizeSpellConfig(unit.spellConfig);

            const updateSpellConfig = (cfg) => {
                onUpdate(unit.id, { ...unit, spellConfig: normalizeSpellConfig(cfg) });
            };

            const handleToggleColour = (colour) => {
                const current = normalizeSpellConfig(unit.spellConfig);
                const isSelected = current.colours.includes(colour);
                if (isSelected) {
                    const newColours = current.colours.filter(c => c !== colour);
                    const newSelectedSpells = (current.selectedSpells || []).filter(s => s.colour !== colour);
                    updateSpellConfig({ ...current, colours: newColours, selectedSpells: newSelectedSpells });
                } else {
                    if (current.colours.length >= spellLevel) return;
                    updateSpellConfig({ ...current, colours: [...current.colours, colour] });
                }
            };

            const handleToggleSpell = (colour, spellName) => {
                const current = normalizeSpellConfig(unit.spellConfig);
                const existing = current.selectedSpells || [];
                const idx = existing.findIndex(s => s.colour === colour && s.name === spellName);
                if (idx >= 0) {
                    const copy = existing.slice();
                    copy.splice(idx, 1);
                    updateSpellConfig({ ...current, selectedSpells: copy });
                } else {
                    updateSpellConfig({
                        ...current,
                        selectedSpells: [...existing, { colour, name: spellName }]
                    });
                }
            };

            const selectedSpellObjects = (() => {
                const cfg = normalizeSpellConfig(unit.spellConfig);
                const result = [];
                for (const colour of cfg.colours) {
                    const spells = SPELLBOOK[colour] || [];
                    spells.forEach(sp => {
                        const chosen = (cfg.selectedSpells || []).some(s => s.name === sp.name && s.colour === colour);
                        if (chosen) {
                            result.push({ colour, name: sp.name, summary: sp.summary });
                        }
                    });
                }
                return result;
            })();

            return (
                <div className={cardClasses}>
                    <div className="flex justify-between items-start mb-3">
                        <div className="w-full mr-4">
                            <div className="flex items-center gap-2 mb-1">
                                <input 
                                    type="text" 
                                    placeholder="Unit Name"
                                    value={unit.customName}
                                    onChange={handleNameChange}
                                    className="w-full bg-transparent text-xl font-bold text-amber-500 border-b border-stone-700 focus:border-amber-500 outline-none pb-1 placeholder-stone-600 fantasy-font"
                                />
                            </div>
                            <div className="text-stone-400 text-sm mt-1 flex items-center gap-2">
                                <span className="font-semibold text-stone-300">{unit.name}</span>
                                <span className="text-xs bg-stone-800 px-2 py-0.5 rounded text-stone-500">SP: {unit.sp}</span>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            <div className="flex items-center gap-2 no-print">
                                <label className="flex items-center gap-1 text-xs text-amber-300 cursor-pointer select-none">
                                    <input
                                        type="checkbox"
                                        checked={!!unit.isLeader}
                                        onChange={() => onSetLeader(unit.id)}
                                        className="accent-amber-400"
                                    />
                                    <Icon name="crown" size={16} />
                                    <span>Leader</span>
                                </label>
                            </div>
                            <div className="text-2xl font-bold text-amber-400 fantasy-font whitespace-nowrap">
                                {totalCost} pts
                            </div>
                            <div className="flex gap-1 mt-1 no-print">
                                <button onClick={() => onDuplicate(unit)} className="p-1.5 text-stone-400 hover:text-blue-400 transition-colors" title="Duplicate">
                                    <Icon name="copy" />
                                </button>
                                <button onClick={() => onDelete(unit.id)} className="p-1.5 text-stone-400 hover:text-red-500 transition-colors" title="Delete">
                                    <Icon name="trash" />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-6 gap-1 mb-4 text-center text-sm">
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Att</div>
                            <div className="font-bold text-stone-200">{unit.attackOrder}/{unit.attackVal}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Sht</div>
                            <div className="font-bold text-stone-200">{unit.shootOrder}/{unit.shootVal}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Mov</div>
                            <div className="font-bold text-stone-200">{unit.moveOrder}/{unit.moveDist}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Arm</div>
                            <div className="font-bold text-stone-200">{unit.armor}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Def</div>
                            <div className="font-bold text-stone-200">{unit.defense}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Cour</div>
                            <div className="font-bold text-stone-200">{unit.courage}</div>
                        </div>
                    </div>

                    {/* Rules & Upgrades */}
                    <div className="space-y-2">
                        {/* Default Rules */}
                        {unit.rules.length > 0 && (
                            <div className="text-sm text-stone-400">
                                <span className="font-semibold text-stone-500">Traits: </span>
                                {unit.rules.join(", ")}
                            </div>
                        )}

                        {/* Selected Upgrades */}
                        <div className="space-y-1">
                            {(unit.selectedUpgrades || []).map((upgrade, idx) => {
                                const isLeaderUpgrade = upgrade.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1;
                                const leaderStyle =
                                    isLeaderUpgrade && unit.isLeader
                                        ? "border-amber-500/70 bg-amber-950/40"
                                        : isLeaderUpgrade && !unit.isLeader
                                        ? "border-red-700/70 bg-red-950/30"
                                        : "border-stone-700 bg-stone-800";

                                return (
                                    <div
                                        key={idx}
                                        className={`flex justify-between items-start text-sm p-2 rounded border ${leaderStyle}`}
                                    >
                                        <div>
                                            <span className="font-semibold">
                                                <span className={isLeaderUpgrade ? (unit.isLeader ? "text-amber-300" : "text-red-300") : "text-amber-500"}>
                                                    {upgrade.name}
                                                </span>
                                            </span>
                                            <span className="text-stone-500 text-xs ml-1">
                                                ({upgrade.cost > 0 ? "+" : ""}{upgrade.cost} pts)
                                            </span>
                                            <div className="text-xs text-stone-300 italic mt-0.5">
                                                {upgrade.desc}
                                            </div>
                                            {isLeaderUpgrade && !unit.isLeader && (
                                                <div className="text-[10px] text-red-300 mt-0.5">
                                                    Leader trait is on a non-Leader unit.
                                                </div>
                                            )}
                                        </div>
                                        <button 
                                            onClick={() => removeUpgrade(upgrade.name)}
                                            className="text-stone-500 hover:text-red-400 ml-2 no-print"
                                        >
                                            <Icon name="x" size={14} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Spellcaster configuration */}
                        {spellLevel > 0 && (
                            <div className="mt-3 text-xs border border-indigo-700/70 bg-stone-950/60 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                    <div className="flex items-center gap-1 font-semibold text-indigo-200">
                                        <Icon name="sparkle" size={14} />
                                        <span>Spellcaster Level {spellLevel}</span>
                                    </div>
                                    <div className="text-[11px] text-indigo-200">
                                        Colours chosen: {spellConfig.colours.length}/{spellLevel}
                                    </div>
                                </div>

                                {/* Colour selection (no-print) */}
                                <div className="no-print mb-2">
                                    <div className="grid grid-cols-2 gap-1">
                                        {SPELL_COLOURS.map(colour => {
                                            const selected = spellConfig.colours.includes(colour);
                                            const disabled = !selected && spellConfig.colours.length >= spellLevel;
                                            return (
                                                <label
                                                    key={colour}
                                                    className={`flex items-center gap-1 text-[11px] cursor-pointer ${disabled ? "opacity-40" : ""}`}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selected}
                                                        disabled={disabled && !selected}
                                                        onChange={() => handleToggleColour(colour)}
                                                        className="accent-indigo-400"
                                                    />
                                                    <span>{colour} Magic</span>
                                                </label>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-1 text-[10px] text-stone-400">
                                        Pick up to {spellLevel} colours. A colour gives access to all its spells.
                                    </div>
                                </div>

                                {/* Spell list & quick reference (prints) */}
                                {spellConfig.colours.length > 0 && (
                                    <div className="space-y-1">
                                        {spellConfig.colours.map(colour => (
                                            <div key={colour} className="mt-1">
                                                <div className="text-[11px] uppercase tracking-wide text-indigo-200">
                                                    {colour} Magic
                                                </div>
                                                <ul className="mt-0.5 space-y-0.5">
                                                    {(SPELLBOOK[colour] || []).map(spell => {
                                                        const isSelected =
                                                            (spellConfig.selectedSpells || []).some(
                                                                s => s.name === spell.name && s.colour === colour
                                                            );
                                                        return (
                                                            <li key={colour + ":" + spell.name} className="flex items-start gap-1">
                                                                <input
                                                                    type="checkbox"
                                                                    className="no-print mt-[2px] accent-indigo-400"
                                                                    checked={!!isSelected}
                                                                    onChange={() => handleToggleSpell(colour, spell.name)}
                                                                />
                                                                <div className="text-[11px] leading-snug">
                                                                    <span className="font-semibold text-indigo-100">
                                                                        {spell.name}
                                                                    </span>
                                                                    <span className="text-stone-300"> – {spell.summary}</span>
                                                                </div>
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {selectedSpellObjects.length > 0 && (
                                    <div className="mt-2 text-[10px] text-stone-400">
                                        Tick spells above to include them in this unit’s quick-reference list.
                                        They will print with the card for use at the table.
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Upgrade Selector */}
                        <div className="mt-3 no-print">
                            <select 
                                className="w-full bg-stone-800 text-stone-300 text-sm border border-stone-600 rounded p-2 focus:border-amber-500 outline-none"
                                onChange={addUpgrade}
                                defaultValue=""
                            >
                                <option value="" disabled>+ Add Fantastical Rule / Upgrade</option>
                                {UPGRADES_LIST.map(u => (
                                    <option
                                        key={u.name}
                                        value={u.name}
                                        disabled={(unit.selectedUpgrades || []).some(sel => sel.name === u.name) && !SPELL_UPGRADE_NAMES.includes(u.name)}
                                    >
                                        {u.name} ({u.cost > 0 ? '+' : ''}{u.cost})
                                    </option>
                                ))}
                            </select>
                        </div>

                        {hasLeaderUpgradeOnNonLeader && (
                            <div className="mt-2 text-[11px] text-red-300 no-print">
                                This unit has Leader traits but is not marked as the warband Leader.
                            </div>
                        )}

                        {unit.isLeader && (
                            <div className="mt-2 text-[11px] text-amber-300 uppercase tracking-wide">
                                <Icon name="crown" size={12} className="inline mr-1" />
                                Warband Leader
                            </div>
                        )}

                        {/* Printed spell quick reference (chosen spells only) */}
                        {selectedSpellObjects.length > 0 && (
                            <div className="mt-3 text-[11px] border-t border-stone-700 pt-2">
                                <div className="font-semibold mb-1">
                                    <Icon name="book-open-text" size={12} className="inline mr-1" />
                                    Spell Quick Reference
                                </div>
                                <ul className="space-y-0.5">
                                    {selectedSpellObjects.map((sp, idx) => (
                                        <li key={idx}>
                                            <span className="font-semibold">{sp.name}</span>
                                            <span className="text-stone-400"> ({sp.colour}) – {sp.summary}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [army, setArmy] = useState(() => {
                try {
                    const saved = localStorage.getItem('dr_army_v1');
                    const parsed = saved ? JSON.parse(saved) : [];
                    return Array.isArray(parsed) ? parsed : [];
                } catch {
                    return [];
                }
            });

            const [armyName, setArmyName] = useState(() => {
                return localStorage.getItem('dr_army_name') || "My Warband";
            });

            const [jsonText, setJsonText] = useState("");

            useEffect(() => {
                localStorage.setItem('dr_army_v1', JSON.stringify(army));
            }, [army]);

            useEffect(() => {
                localStorage.setItem('dr_army_name', armyName);
            }, [armyName]);

            const addUnit = (templateName) => {
                const template = UNIT_TEMPLATES.find(t => t.name === templateName);
                if (!template) return;

                const newUnit = {
                    ...template,
                    id: Date.now() + Math.random(),
                    customName: "",
                    selectedUpgrades: [],
                    isLeader: false,
                    spellConfig: { colours: [], selectedSpells: [] }
                };
                setArmy(prev => [...prev, newUnit]);
            };

            const updateUnit = (id, updatedUnit) => {
                setArmy(prev => prev.map(u => (u.id === id ? updatedUnit : u)));
            };

            const deleteUnit = (id) => {
                setArmy(prev => prev.filter(u => u.id !== id));
            };

            const duplicateUnit = (unit) => {
                const cloned = {
                    ...unit,
                    id: Date.now() + Math.random(),
                    customName: unit.customName ? `${unit.customName} (copy)` : "",
                    isLeader: false
                };
                setArmy(prev => [...prev, cloned]);
            };

            const clearArmy = () => {
                if (army.length === 0) return;
                if (window.confirm("Clear all units from this warband?")) {
                    setArmy([]);
                }
            };

            const setLeader = (id) => {
                setArmy(prev => {
                    const clicked = prev.find(u => u.id === id);
                    const willBeLeader = clicked ? !clicked.isLeader : true;
                    return prev.map(u => ({
                        ...u,
                        isLeader: willBeLeader ? u.id === id : false
                    }));
                });
            };

            const totalPoints = army.reduce((sum, unit) => {
                const unitCost = Math.max(
                    0,
                    unit.cost + (unit.selectedUpgrades || []).reduce((s, u) => s + u.cost, 0)
                );
                return sum + unitCost;
            }, 0);

            const isUnitUndead = (unit) => {
                const baseIsUndead = (unit.rules || []).includes("Undead");
                const upgradeIsUndead = (unit.selectedUpgrades || []).some(u => u.name === "Undead");
                return baseIsUndead || upgradeIsUndead;
            };

            const hasUnstoppable = army.some(
                unit => (unit.selectedUpgrades || []).some(up => up.name === UNSTOPPABLE_NAME)
            );
            const allUndead = army.length > 0 && army.every(isUnitUndead);

            const anyLeaderTraitsOnNonLeader = army.some(
                unit =>
                    !unit.isLeader &&
                    (unit.selectedUpgrades || []).some(up => up.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1)
            );

            const handleExportJson = () => {
                const data = {
                    armyName,
                    army,
                    version: 2,
                    exportedAt: new Date().toISOString()
                };
                const pretty = JSON.stringify(data, null, 2);
                setJsonText(pretty);
            };

            const handleImportJson = () => {
                try {
                    const parsed = JSON.parse(jsonText);
                    const importedArmyRaw = parsed.army || [];
                    const importedName = parsed.armyName || "Imported Warband";

                    const normalizedArmy = importedArmyRaw.map((unit, idx) => ({
                        ...unit,
                        id: unit.id || (Date.now() + Math.random() + idx),
                        selectedUpgrades: unit.selectedUpgrades || [],
                        isLeader: !!unit.isLeader,
                        rules: unit.rules || [],
                        spellConfig: normalizeSpellConfig(unit.spellConfig)
                    }));

                    setArmy(normalizedArmy);
                    setArmyName(importedName);
                    window.alert("Army imported successfully.");
                } catch (err) {
                    console.error(err);
                    window.alert("Import failed. Please check the JSON is valid and try again.");
                }
            };

            return (
                <div className="min-h-screen bg-neutral-900 text-stone-100">
                    <header className="no-print border-b border-stone-800 bg-black/80 backdrop-blur sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                            <div className="flex items-center gap-3">
                                <Icon name="sword" size={28} className="text-amber-400" />
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold fantasy-font tracking-wide">
                                        Dragon Rampant Army Builder
                                    </h1>
                                    <p className="text-xs text-stone-400">
                                        Lists are saved locally in this browser (and you can export/import JSON below).
                                    </p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <input
                                    type="text"
                                    value={armyName}
                                    onChange={(e) => setArmyName(e.target.value)}
                                    className="bg-stone-900 border border-stone-700 rounded px-3 py-1 text-sm focus:outline-none focus:border-amber-500 w-full md:w-64"
                                    placeholder="Warband name"
                                />
                                <div className="flex flex-wrap items-center gap-2 text-xs md:text-sm text-stone-300">
                                    <span>
                                        <Icon name="users" size={16} className="inline mr-1" />
                                        {army.length} units
                                    </span>
                                    <span>
                                        <Icon name="coins" size={16} className="inline mr-1 text-amber-300" />
                                        {totalPoints} pts
                                    </span>
                                    <button
                                        onClick={() => window.print()}
                                        className="inline-flex items-center gap-1 px-3 py-1 rounded bg-stone-800 hover:bg-stone-700 text-xs font-semibold"
                                    >
                                        <Icon name="printer" size={14} />
                                        Print
                                    </button>
                                    {army.length > 0 && (
                                        <button
                                            onClick={clearArmy}
                                            className="inline-flex items-center gap-1 px-3 py-1 rounded border border-red-700 text-red-400 hover:bg-red-900/30 text-xs"
                                        >
                                            <Icon name="trash" size={14} />
                                            Clear
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Global warnings */}
                        {(hasUnstoppable && !allUndead) || anyLeaderTraitsOnNonLeader ? (
                            <div className="max-w-6xl mx-auto px-4 pb-3 space-y-1 text-xs no-print">
                                {hasUnstoppable && !allUndead && (
                                    <div className="flex items-start gap-2 text-red-300">
                                        <Icon name="warning-circle" size={14} className="mt-0.5" />
                                        <span>
                                            <strong>Unstoppable March of the Dead (L):</strong> Rules require all units in the
                                            warband to be Undead. At least one unit is not marked as Undead.
                                        </span>
                                    </div>
                                )}
                                {anyLeaderTraitsOnNonLeader && (
                                    <div className="flex items-start gap-2 text-amber-300">
                                        <Icon name="warning" size={14} className="mt-0.5" />
                                        <span>
                                            Some Leader traits are on units that are not marked as the warband Leader. Only the actual Leader
                                            should benefit from Leader traits in the game.
                                        </span>
                                    </div>
                                )}
                            </div>
                        ) : null}
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-4">
                        <div className="grid gap-4 md:grid-cols-[minmax(0,260px),minmax(0,1fr)]">
                            {/* Left panel: add units + JSON tools */}
                            <aside className="no-print">
                                <div className="bg-stone-900 border border-stone-700 rounded-lg p-4 shadow">
                                    <h2 className="text-lg font-semibold fantasy-font mb-3">Add unit</h2>
                                    <p className="text-xs text-stone-400 mb-2">
                                        Choose a template and it will appear on the right.
                                    </p>
                                    <select
                                        className="w-full bg-stone-800 text-stone-100 border border-stone-600 rounded px-2 py-2 text-sm mb-3 focus:outline-none focus:border-amber-500"
                                        onChange={(e) => {
                                            if (e.target.value) {
                                                addUnit(e.target.value);
                                                e.target.value = "";
                                            }
                                        }}
                                        defaultValue=""
                                    >
                                        <option value="" disabled>
                                            Pick a unit type
                                        </option>
                                        {UNIT_TEMPLATES.map((t) => (
                                            <option key={t.name} value={t.name}>
                                                {t.name} ({t.cost} pts)
                                            </option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-stone-500">
                                        Tip: tick <strong>Leader</strong> on the unit that carries your Leader traits.
                                    </p>
                                </div>

                                {/* JSON export/import */}
                                <div className="bg-stone-900 border border-stone-700 rounded-lg p-4 shadow mt-4">
                                    <h2 className="text-sm font-semibold mb-2 flex items-center gap-2">
                                        <Icon name="file-json" size={16} className="text-amber-300" />
                                        Export / Import JSON
                                    </h2>
                                    <p className="text-[11px] text-stone-400 mb-2">
                                        Click <strong>Export</strong> to generate JSON for this warband, then copy and save it somewhere.
                                        Paste JSON back in and click <strong>Import</strong> to load it on another device.
                                    </p>
                                    <textarea
                                        rows="6"
                                        className="w-full bg-stone-950 border border-stone-700 rounded p-2 text-xs text-stone-100 mb-2 font-mono"
                                        placeholder='Click "Export" to generate JSON here, or paste JSON then click "Import".'
                                        value={jsonText}
                                        onChange={(e) => setJsonText(e.target.value)}
                                    ></textarea>
                                    <div className="flex gap-2 justify-end">
                                        <button
                                            type="button"
                                            onClick={handleExportJson}
                                            className="px-3 py-1 rounded bg-stone-800 hover:bg-stone-700 text-xs flex items-center gap-1"
                                        >
                                            <Icon name="export" size={14} />
                                            Export
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleImportJson}
                                            className="px-3 py-1 rounded bg-emerald-800 hover:bg-emerald-700 text-xs flex items-center gap-1"
                                        >
                                            <Icon name="import" size={14} />
                                            Import
                                        </button>
                                    </div>
                                </div>
                            </aside>

                            {/* Right panel: army list */}
                            <section>
                                <h2 className="sr-only">Army list</h2>
                                {army.length === 0 ? (
                                    <div className="border border-dashed border-stone-700 rounded-lg p-8 text-center text-stone-400">
                                        <p className="mb-2 text-sm">No units in this warband yet.</p>
                                        <p className="text-xs">
                                            Use the panel on the left to add your first unit.
                                        </p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {army.map((unit) => (
                                            <UnitCard
                                                key={unit.id}
                                                unit={unit}
                                                onUpdate={updateUnit}
                                                onDelete={deleteUnit}
                                                onDuplicate={duplicateUnit}
                                                onSetLeader={setLeader}
                                            />
                                        ))}
                                    </div>
                                )}
                            </section>
                        </div>
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
