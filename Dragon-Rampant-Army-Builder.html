<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dragon Rampant Army Builder</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');
        
        body {
            font-family: 'Lato', sans-serif;
            background-color: #1a1a1a;
            color: #e5e5e5;
            margin: 0;
        }
        
        h1, h2, h3, .fantasy-font {
            font-family: 'Cinzel', serif;
        }

        .stat-box {
            background-color: #262626;
            border: 1px solid #404040;
        }

        .parchment {
            background-color: #f3f0e6;
            color: #1a1a1a;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666; 
        }

        @media print {
            body {
                background-color: white;
                color: black;
            }
            .no-print {
                display: none !important;
            }
            .card-print {
                border: 1px solid #ccc;
                break-inside: avoid;
                margin-bottom: 1rem;
                background-color: white !important;
                color: black !important;
            }
            .text-amber-500,
            .text-amber-400,
            .text-amber-300 {
                color: #000 !important;
            }
            .bg-stone-900,
            .bg-stone-800,
            .bg-stone-950 {
                background-color: #fff !important;
                border-color: #000 !important;
            }
            .text-stone-300,
            .text-stone-400,
            .text-stone-500,
            .text-stone-200 {
                color: #333 !important;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div style="color:white; padding:1rem; font-family:sans-serif;">
            If you only see this message and nothing else, JavaScript or the CDNs have not loaded.
            Try opening this file in Chrome or another browser with an internet connection.
        </div>
    </div>

    <!-- Main app -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect } = React;

        // --- DATA: Unit Profiles ---
        const UNIT_TEMPLATES = [
            { name: "Elite Riders", sp: 6, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "7+", moveDist: '10"', armor: 4, defense: "5+", courage: "3+", rules: ["Wild Charge", "Counter-Charge"] },
            { name: "Heavy Riders", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '10"', armor: 3, defense: "5+", courage: "4+", rules: ["Counter-Charge"] },
            { name: "Light Riders", sp: 6, cost: 4, attackOrder: "7+", attackVal: "5+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '12"', armor: 3, defense: "6+", courage: "5+", rules: ["Skirmish", "Evade"] },
            { name: "Greater Warbeasts", sp: 6, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '10"', armor: 4, defense: "6+", courage: "3+", rules: ["Ranger", "Wild Charge", "Stomper"] },
            { name: "Lesser Warbeasts", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '12"', armor: 3, defense: "6+", courage: "4+", rules: ["Ranger", "Wild Charge", "Fleet Footed"] },
            { name: "Elite Foot", sp: 12, cost: 6, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 4, defense: "5+", courage: "3+", rules: ["Wild Charge"] },
            { name: "Heavy Foot", sp: 12, cost: 4, attackOrder: "6+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 3, defense: "5+", courage: "4+", rules: ["Wall of Spears"] },
            { name: "Light Foot", sp: 12, cost: 3, attackOrder: "6+", attackVal: "5+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '8"', armor: 2, defense: "5+", courage: "4+", rules: ["Offensive", "Wall of Spears"] }, 
            { name: "Bellicose Foot", sp: 12, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 2, defense: "6+", courage: "3+", rules: ["Wild Charge", "Counter-Charge"] },
            { name: "Heavy Missiles", sp: 12, cost: 4, attackOrder: "7+", attackVal: "5+", shootOrder: "6+", shootVal: "4+ / 18\"", moveOrder: "6+", moveDist: '6"', armor: 3, defense: "6+", courage: "4+", rules: [] },
            { name: "Light Missiles", sp: 12, cost: 4, attackOrder: "7+", attackVal: "6+", shootOrder: "6+", shootVal: "5+ / 18\"", moveOrder: "5+", moveDist: '8"', armor: 2, defense: "6+", courage: "4+", rules: ["Skirmish", "Evade"] },
            { name: "Scouts", sp: 6, cost: 2, attackOrder: "7+", attackVal: "6+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '8"', armor: 1, defense: "6+", courage: "5+", rules: ["Skirmish", "Evade"] },
            { name: "Ravenous Hordes", sp: 12, cost: 1, attackOrder: "6+", attackVal: "6+", shootOrder: "-", shootVal: "-", moveOrder: "5+", moveDist: '6"', armor: 1, defense: "6+", courage: "5+", rules: ["Wild Charge"] },
            { name: "Chariots", sp: 6, cost: 4, attackOrder: "5+", attackVal: "4+", shootOrder: "6+", shootVal: "5+ / 12\"", moveOrder: "5+", moveDist: '8"', armor: 3, defense: "6+", courage: "4+", rules: ["Linear"] },
            { name: "Beserkers", sp: 6, cost: 4, attackOrder: "5+", attackVal: "3+", shootOrder: "-", shootVal: "-", moveOrder: "6+", moveDist: '8"', armor: 2, defense: "6+", courage: "3+", rules: ["Wild Charge", "Beserk"] }
        ];

        // --- DATA: Fantastical Rules & Upgrades (now matching your full list) ---
        const UPGRADES_LIST = [
            // Leader-only traits (we tag with (L) for detection)
            {
                name: "Brutal (L)",
                cost: 1,
                desc: "Leader only. Friendly units within 12\" may sacrifice 1 Strength Point to automatically pass a Rally test."
            },
            {
                name: "Divine Leadership (L)",
                cost: 2,
                desc: "Leader only. Grants Spell Resistant to all friendly units within 12\" of this Leader."
            },
            {
                name: "Insipid (L)",
                cost: -1,
                desc: "Leader only. This Leader provides no Courage bonus to nearby units."
            },
            {
                name: "Unstoppable March of the Dead (L)",
                cost: 3,
                desc: "Undead Leader only. Warband ignores most Courage test triggers (e.g. Leader death) except for taking casualties."
            },
            {
                name: "Wise Old Owl (L)",
                cost: 1,
                desc: "Leader only. Add or subtract 1 from the die roll when determining Attacker/Defender."
            },

            // A–C
            {
                name: "18/00 Strength",
                cost: 4,
                desc: "Reroll up to three failed hit dice when Attacking or Defending. Only one unit allowed per 24 army points."
            },
            {
                name: "Amphibious",
                cost: 1,
                desc: "Counts as Fast, Ranger, and Fleet Footed while in water-based terrain."
            },
            {
                name: "Berserk",
                cost: 2,
                desc: "Attack dice that roll a 6 cause a hit and are rolled again (exploding 6s). Stops working if the unit is at half strength or below."
            },
            {
                name: "Blessed Blades",
                cost: 4,
                desc: "Roll 3 additional dice when Attacking or Defending. Only one unit allowed per 24 army points."
            },
            {
                name: "Bloodthirsty",
                cost: 3,
                desc: "Effect is identical to Venomous (6s count as 2 hits). Choose this name for flavour."
            },
            {
                name: "Bodkins",
                cost: 3,
                desc: "When Shooting, each die that rolls a 6 causes 2 hits."
            },
            {
                name: "Burrower",
                cost: 2,
                desc: "Unit is held in reserve and dices from turn 3 onwards to appear anywhere on the table away from enemies."
            },
            {
                name: "Cannibalistic",
                cost: 3,
                desc: "Regain 1 lost Strength Point every time this unit inflicts damage on an enemy."
            },
            {
                name: "Champion (Hewing)",
                cost: 1,
                desc: "Melee Champion. Reroll one failed hit die in melee. Combine with Champion (Eagle-Eyed) for the full 2-point Champion."
            },
            {
                name: "Champion (Eagle-Eyed)",
                cost: 1,
                desc: "Shooting Champion. Reroll one failed hit die when Shooting. Combine with Champion (Hewing) for the full 2-point Champion."
            },
            {
                name: "Chaotic",
                cost: 1,
                desc: "Use a 12-sided die (d12) for all rolls instead of 2d6."
            },
            {
                name: "Cleric",
                cost: 2,
                desc: "Counts as Courageous. Against Undead also counts as Champion and Repellent. Cost is 2–4 depending on how many Undead the opponent has; builder uses 2 as a base – adjust manually if needed."
            },
            {
                name: "Concealment",
                cost: 3,
                desc: "Unit cannot be Shot at, Attacked, or Wild Charged if the enemy starts more than 6\" away."
            },
            {
                name: "Courageous",
                cost: 2,
                desc: "Automatically pass one Courage test per game."
            },
            {
                name: "Cowardly",
                cost: -1,
                desc: "When Retreating, the unit must fall back its full movement distance instead of half."
            },
            {
                name: "Cursed",
                cost: -1,
                desc: "If the unit takes at least 1 hit, it takes 1 additional hit."
            },

            // D–H
            {
                name: "Drums and Flags",
                cost: 2,
                desc: "Improves the unit’s Courage by 1 point."
            },
            {
                name: "Enchanted Blades",
                cost: 3,
                desc: "Roll 2 additional dice when Attacking or Defending."
            },
            {
                name: "Exploder",
                cost: 2,
                desc: "Unit can be ordered to explode, causing a Strength 3+ hit on every unit (friend and foe) within 6\"."
            },
            {
                name: "Fanatical",
                cost: 2,
                desc: "May reroll unsuccessful Rally tests."
            },
            {
                name: "Fast",
                cost: 1,
                desc: "Maximum Move distance is increased by 2\"."
            },
            {
                name: "Fearful",
                cost: -1,
                desc: "Suffers -1 to all Courage tests (-2 if attacked by Fearsome)."
            },
            {
                name: "Fearless",
                cost: 1,
                desc: "Ignores the penalties caused by Fearsome enemies."
            },
            {
                name: "Fearsome",
                cost: 2,
                desc: "Enemies Attacking this unit suffer -1 to their Courage tests."
            },
            {
                name: "Flyer",
                cost: 2,
                desc: "Moves over other units and terrain; ignores terrain and cover effects during movement and Attacks."
            },
            {
                name: "Hatred",
                cost: 1,
                desc: "Gains Wild Charge against one specific race chosen before the game."
            },

            // I–R
            {
                name: "Large",
                cost: 1,
                desc: "Adds +2 to the unit's starting Strength Points. Cost is 1–3 depending on Armour; builder uses 1 as a base – check the rules and adjust manually."
            },
            {
                name: "Longer Range",
                cost: 2,
                desc: "Increases the unit’s Shooting range by 4\"."
            },
            {
                name: "Lucky",
                cost: 3,
                desc: "Force a reroll of any one set of dice (friend or foe) once per game. Only one Lucky unit per 24 army points."
            },
            {
                name: "Magical Missiles",
                cost: 3,
                desc: "Roll 2 additional dice when Shooting."
            },
            {
                name: "Mystical Armour",
                cost: 2,
                desc: "Each time the unit loses a Strength Point, roll a die; on a 6, the damage is ignored."
            },
            {
                name: "Regeneration",
                cost: 3,
                desc: "On a successful Move order the unit may choose to stand still and regain 1 lost Strength Point instead of moving."
            },
            {
                name: "Repellent",
                cost: 2,
                desc: "Enemies suffer -1 to their activation rolls when trying to Attack this unit."
            },
            {
                name: "Ring of Uncertain Power",
                cost: 2,
                desc: "Roll on a random table at the start of the game to determine a permanent (possibly risky) magical effect."
            },

            // S–Z
            {
                name: "Slayer",
                cost: 2,
                desc: "Functions like Cleric but aimed at a specific enemy type (e.g. Goblin Slayer, Beast Slayer). Cost can vary by opponent; builder uses 2 as a base – adjust manually if needed."
            },
            {
                name: "Slow",
                cost: -1,
                desc: "Maximum Move distance is reduced by 2\"."
            },
            {
                name: "Sneakers",
                cost: 1,
                desc: "Unit may make one free Move action before the game begins."
            },

            // Spellcaster levels – we expose as Lv1–Lv4 for clarity
            {
                name: "Spellcaster Lv1",
                cost: 1,
                desc: "Spellcaster Level 1. Knows 1 colour of magic from the Spellbook."
            },
            {
                name: "Spellcaster Lv2",
                cost: 2,
                desc: "Spellcaster Level 2. Knows 2 colours of magic from the Spellbook."
            },
            {
                name: "Spellcaster Lv3",
                cost: 3,
                desc: "Spellcaster Level 3. Knows 3 colours of magic from the Spellbook."
            },
            {
                name: "Spellcaster Lv4",
                cost: 4,
                desc: "Spellcaster Level 4. Knows 4 colours of magic from the Spellbook."
            },

            {
                name: "Spell Resistant",
                cost: 1,
                desc: "Ignore the effect of a Spell on a roll of 5+."
            },
            {
                name: "Super Spell Resistant",
                cost: 2,
                desc: "Ignore the effect of a Spell on a roll of 4+."
            },
            {
                name: "Summoner",
                cost: 3,
                desc: "May attempt to summon allies (up to 50% of your warband’s points) onto the table during the game."
            },
            {
                name: "Undead",
                cost: 0,
                desc: "Courage becomes 0+ (never Battered, but routs on negative scores). Fragile (hits taken are rounded up). Ignores Fearsome."
            },
            {
                name: "Venomous",
                cost: 3,
                desc: "Attack dice that roll a 6 cause 2 hits."
            },
            {
                name: "Weak",
                cost: -1,
                desc: "Unit rolls 1 fewer die when Attacking or Shooting."
            },
            {
                name: "Well Led",
                cost: 1,
                desc: "May reroll a single test or activation once per game."
            },
            {
                name: "Were-Creature",
                cost: 2,
                desc: "Unit starts in human form but transforms into a Lesser Warbeast-style unit after taking damage. Cost is 2 plus any additional profile cost; builder shows the base 2 – adjust manually."
            }
        ].sort((a, b) => a.name.localeCompare(b.name));

        const LEADER_UPGRADE_SUFFIX = "(L)";
        const UNSTOPPABLE_NAME = "Unstoppable March of the Dead (L)";

        // --- DATA: Spellbook (colours & spells) with your summaries ---
        const SPELLBOOK = {
            Amber: [
                {
                    name: "Almighty Prod!",
                    difficulty: "6+",
                    target: `Friendly unit within 18".`,
                    effect: `If the unit fails an ordered activation roll, it may immediately reroll it once. The spell ends immediately after use.`
                },
                {
                    name: "Be Brave!",
                    difficulty: "6+",
                    target: `Friendly unit within 18".`,
                    effect: `The unit may reroll all failed Courage tests (once per test).`
                }
            ],
            Crimson: [
                {
                    name: "Take That You Rotter!",
                    difficulty: "7+",
                    target: `Enemy unit within 18".`,
                    effect: `Immediate magical attack. Treat as a Shoot action with a Shoot Value of 5+ (suffers -1 to rolls if over 12" away).`
                },
                {
                    name: "Utter Chaos!",
                    difficulty: "6+",
                    target: `Any unit within 18".`,
                    effect: `Target gains the Chaotic rule (uses a d12 for rolls instead of 2d6).`
                }
            ],
            Emerald: [
                {
                    name: "Heal Thee!",
                    difficulty: "6+",
                    target: `Friendly unit within 18" (cannot target self).`,
                    effect: `Restores 1 Strength Point (cannot exceed starting value). If the casting roll was an 8+, restores 2 Strength Points.`
                },
                {
                    name: "Sod-Off Spell!",
                    difficulty: "8+",
                    target: `Any bespelled unit within 18".`,
                    effect: `Immediate cancellation of any spell currently affecting the target.`
                }
            ],
            Indigo: [
                {
                    name: "Superglue You!",
                    difficulty: "7+",
                    target: `Self or any unit within 18".`,
                    effect: `Target cannot move or Retreat (enemies bounce off). They are stuck in place.`
                },
                {
                    name: "You Shall Not Pass!",
                    difficulty: "8+",
                    target: `A spot within 12" and line of sight.`,
                    effect: `Places a 12" long, 1" thick impassable barrier. Blocks line of sight, movement, shooting, and attacking.`
                }
            ],
            Jade: [
                {
                    name: "Bog Thee!",
                    difficulty: "7+",
                    target: `Enemy unit within 18".`,
                    effect: `Target counts as being in rough terrain for any movement or combat.`
                },
                {
                    name: "Spring Heeled!",
                    difficulty: "6+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target does not halve its movement distance in rough terrain.`
                },
                {
                    name: "You Have Wings!",
                    difficulty: "7+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target gains the Flyer rule.`
                }
            ],
            Magenta: [
                {
                    name: "Sharp Blades!",
                    difficulty: "7+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target rerolls all failed Attack or Defence dice.`
                },
                {
                    name: "Sharp Darts!",
                    difficulty: "7+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target rerolls all failed Shooting dice.`
                },
                {
                    name: "Stronger Shields!",
                    difficulty: "7+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target's Armour increases by 1.`
                }
            ],
            Saffron: [
                {
                    name: "Dragon's Breath!",
                    difficulty: "6+",
                    target: `Self or any unit within 18".`,
                    effect: `Creates a wall of mist. Target cannot Shoot or be Shot at, but moves as normal.`
                },
                {
                    name: "Go Wild!",
                    difficulty: "6+",
                    target: `Self or friendly unit within 18".`,
                    effect: `Target gains the Berserk rule. Can be used to reinvigorate a Berserk unit that has dropped to half strength.`
                }
            ],
            Turquoise: [
                {
                    name: "Teleport Thee!",
                    difficulty: "7+",
                    target: `Self or friendly unit within 12".`,
                    effect: `Immediate. Move target up to 12" in any direction (cannot engage enemies or enter impassable terrain).`
                },
                {
                    name: "Transpose Thee!",
                    difficulty: "8+",
                    target: `Two units (friend or foe) within 12" of the caster AND 12" of each other.`,
                    effect: `Immediate. The two units swap places. Caster cannot target itself.`
                }
            ],
            Violet: [
                {
                    name: "Befuddle Thee!",
                    difficulty: "8+",
                    target: `Enemy unit within 18".`,
                    effect: `Automatically Batters a non-Battered target. Duration lasts until the target Rallies. Cannot affect Undead.`
                },
                {
                    name: "Curse Thee!",
                    difficulty: "7+",
                    target: `Enemy unit within 18".`,
                    effect: `Target gains the Cursed rule (takes an extra hit whenever it takes at least one hit).`
                }
            ]
        };

        const SPELL_COLOURS = Object.keys(SPELLBOOK);

        // --- Helpers for Spellcaster handling ---
        const SPELL_UPGRADE_NAMES = [
            "Spellcaster Lv1",
            "Spellcaster Lv2",
            "Spellcaster Lv3",
            "Spellcaster Lv4",
            "Spellcaster Lv1 (old)",
            "Spellcaster Lv2 (old)",
            "Spellcaster Lv3 (old)",
            "Spellcaster Lv1*",
            "Spellcaster Lv2*",
            "Spellcaster Lv3*"
        ];

        function getSpellcasterLevel(unit) {
            const names = (unit.selectedUpgrades || []).map(u => u.name);
            if (names.includes("Spellcaster Lv4")) return 4;
            if (names.includes("Spellcaster Lv3") || names.includes("Spellcaster Lv3*") || names.includes("Spellcaster Lv3 (old)")) return 3;
            if (names.includes("Spellcaster Lv2") || names.includes("Spellcaster Lv2*") || names.includes("Spellcaster Lv2 (old)")) return 2;
            if (names.includes("Spellcaster Lv1") || names.includes("Spellcaster Lv1*") || names.includes("Spellcaster Lv1 (old)")) return 1;
            return 0;
        }

        function normalizeSpellConfig(raw) {
            if (!raw || typeof raw !== "object") {
                return { colours: [], selectedSpells: [] };
            }
            const colours = Array.isArray(raw.colours) ? raw.colours.filter(c => SPELL_COLOURS.includes(c)) : [];
            const selectedSpells = Array.isArray(raw.selectedSpells)
                ? raw.selectedSpells
                    .filter(s => s && s.name && s.colour && SPELL_COLOURS.includes(s.colour))
                    .map(s => ({ name: s.name, colour: s.colour }))
                : [];
            return { colours, selectedSpells };
        }

        // Icon wrapper
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i className={`ph ph-${name} ${className}`} style={{ fontSize: size }}></i>;
        };

        const UnitCard = ({ unit, onUpdate, onDelete, onDuplicate, onSetLeader }) => {
            const handleNameChange = (e) => {
                onUpdate(unit.id, { ...unit, customName: e.target.value });
            };

            const addUpgrade = (e) => {
                const upgradeName = e.target.value;
                if (!upgradeName) return;
                
                const upgradeObj = UPGRADES_LIST.find(u => u.name === upgradeName);
                const currentUpgrades = unit.selectedUpgrades || [];

                // Prevent stacking multiple Spellcaster levels accidentally
                const isSpellUpgrade = SPELL_UPGRADE_NAMES.includes(upgradeName);
                let newUpgrades = currentUpgrades.slice();

                if (isSpellUpgrade) {
                    newUpgrades = currentUpgrades.filter(u => !SPELL_UPGRADE_NAMES.includes(u.name));
                    if (!newUpgrades.some(u => u.name === upgradeName) && upgradeObj) {
                        newUpgrades.push(upgradeObj);
                    }
                } else {
                    if (!currentUpgrades.some(u => u.name === upgradeName) && upgradeObj) {
                        newUpgrades = [...currentUpgrades, upgradeObj];
                    }
                }

                onUpdate(unit.id, { 
                    ...unit, 
                    selectedUpgrades: newUpgrades 
                });

                e.target.value = "";
            };

            const removeUpgrade = (upgradeName) => {
                onUpdate(unit.id, {
                    ...unit,
                    selectedUpgrades: (unit.selectedUpgrades || []).filter(u => u.name !== upgradeName)
                });
            };

            const totalCost = Math.max(
                0,
                unit.cost + (unit.selectedUpgrades || []).reduce((sum, u) => sum + u.cost, 0)
            );

            const cardClasses =
                "border rounded-lg p-4 mb-4 shadow-lg card-print relative " +
                (unit.isLeader
                    ? "bg-stone-900 border-amber-500 ring-1 ring-amber-500/60"
                    : "bg-stone-900 border-stone-700");

            const hasLeaderUpgradeOnNonLeader =
                !unit.isLeader &&
                (unit.selectedUpgrades || []).some(up => up.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1);

            const spellLevel = getSpellcasterLevel(unit);
            const spellConfig = normalizeSpellConfig(unit.spellConfig);

            const updateSpellConfig = (cfg) => {
                onUpdate(unit.id, { ...unit, spellConfig: normalizeSpellConfig(cfg) });
            };

            const handleToggleColour = (colour) => {
                const current = normalizeSpellConfig(unit.spellConfig);
                const isSelected = current.colours.includes(colour);
                if (isSelected) {
                    const newColours = current.colours.filter(c => c !== colour);
                    const newSelectedSpells = (current.selectedSpells || []).filter(s => s.colour !== colour);
                    updateSpellConfig({ ...current, colours: newColours, selectedSpells: newSelectedSpells });
                } else {
                    if (current.colours.length >= spellLevel) return;
                    updateSpellConfig({ ...current, colours: [...current.colours, colour] });
                }
            };

            const handleToggleSpell = (colour, spellName) => {
                const current = normalizeSpellConfig(unit.spellConfig);
                const existing = current.selectedSpells || [];
                const idx = existing.findIndex(s => s.colour === colour && s.name === spellName);
                if (idx >= 0) {
                    const copy = existing.slice();
                    copy.splice(idx, 1);
                    updateSpellConfig({ ...current, selectedSpells: copy });
                } else {
                    updateSpellConfig({
                        ...current,
                        selectedSpells: [...existing, { colour, name: spellName }]
                    });
                }
            };

            const selectedSpellObjects = (() => {
                const cfg = normalizeSpellConfig(unit.spellConfig);
                const result = [];
                for (const colour of cfg.colours) {
                    const spells = SPELLBOOK[colour] || [];
                    spells.forEach(sp => {
                        const chosen = (cfg.selectedSpells || []).some(s => s.name === sp.name && s.colour === colour);
                        if (chosen) {
                            result.push({
                                colour,
                                name: sp.name,
                                difficulty: sp.difficulty,
                                target: sp.target,
                                effect: sp.effect
                            });
                        }
                    });
                }
                return result;
            })();

            return (
                <div className={cardClasses}>
                    <div className="flex justify-between items-start mb-3">
                        <div className="w-full mr-4">
                            <div className="flex items-center gap-2 mb-1">
                                <input 
                                    type="text" 
                                    placeholder="Unit Name"
                                    value={unit.customName}
                                    onChange={handleNameChange}
                                    className="w-full bg-transparent text-xl font-bold text-amber-500 border-b border-stone-700 focus:border-amber-500 outline-none pb-1 placeholder-stone-600 fantasy-font"
                                />
                            </div>
                            <div className="text-stone-400 text-sm mt-1 flex items-center gap-2">
                                <span className="font-semibold text-stone-300">{unit.name}</span>
                                <span className="text-xs bg-stone-800 px-2 py-0.5 rounded text-stone-500">SP: {unit.sp}</span>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                            <div className="flex items-center gap-2 no-print">
                                <label className="flex items-center gap-1 text-xs text-amber-300 cursor-pointer select-none">
                                    <input
                                        type="checkbox"
                                        checked={!!unit.isLeader}
                                        onChange={() => onSetLeader(unit.id)}
                                        className="accent-amber-400"
                                    />
                                    <Icon name="crown" size={16} />
                                    <span>Leader</span>
                                </label>
                            </div>
                            <div className="text-2xl font-bold text-amber-400 fantasy-font whitespace-nowrap">
                                {totalCost} pts
                            </div>
                            <div className="flex gap-1 mt-1 no-print">
                                <button onClick={() => onDuplicate(unit)} className="p-1.5 text-stone-400 hover:text-blue-400 transition-colors" title="Duplicate">
                                    <Icon name="copy" />
                                </button>
                                <button onClick={() => onDelete(unit.id)} className="p-1.5 text-stone-400 hover:text-red-500 transition-colors" title="Delete">
                                    <Icon name="trash" />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-6 gap-1 mb-4 text-center text-sm">
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Att</div>
                            <div className="font-bold text-stone-200">{unit.attackOrder}/{unit.attackVal}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Sht</div>
                            <div className="font-bold text-stone-200">{unit.shootOrder}/{unit.shootVal}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Mov</div>
                            <div className="font-bold text-stone-200">{unit.moveOrder}/{unit.moveDist}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Arm</div>
                            <div className="font-bold text-stone-200">{unit.armor}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Def</div>
                            <div className="font-bold text-stone-200">{unit.defense}</div>
                        </div>
                        <div className="stat-box p-1 rounded">
                            <div className="text-xs text-stone-500 uppercase">Cour</div>
                            <div className="font-bold text-stone-200">{unit.courage}</div>
                        </div>
                    </div>

                    {/* Rules & Upgrades */}
                    <div className="space-y-2">
                        {/* Default Rules */}
                        {unit.rules.length > 0 && (
                            <div className="text-sm text-stone-400">
                                <span className="font-semibold text-stone-500">Traits: </span>
                                {unit.rules.join(", ")}
                            </div>
                        )}

                        {/* Selected Upgrades */}
                        <div className="space-y-1">
                            {(unit.selectedUpgrades || []).map((upgrade, idx) => {
                                const isLeaderUpgrade = upgrade.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1;
                                const leaderStyle =
                                    isLeaderUpgrade && unit.isLeader
                                        ? "border-amber-500/70 bg-amber-950/40"
                                        : isLeaderUpgrade && !unit.isLeader
                                        ? "border-red-700/70 bg-red-950/30"
                                        : "border-stone-700 bg-stone-800";

                                return (
                                    <div
                                        key={idx}
                                        className={`flex justify-between items-start text-sm p-2 rounded border ${leaderStyle}`}
                                    >
                                        <div>
                                            <span className="font-semibold">
                                                <span className={isLeaderUpgrade ? (unit.isLeader ? "text-amber-300" : "text-red-300") : "text-amber-500"}>
                                                    {upgrade.name}
                                                </span>
                                            </span>
                                            <span className="text-stone-500 text-xs ml-1">
                                                ({upgrade.cost > 0 ? "+" : ""}{upgrade.cost} pts)
                                            </span>
                                            <div className="text-xs text-stone-300 italic mt-0.5">
                                                {upgrade.desc}
                                            </div>
                                            {isLeaderUpgrade && !unit.isLeader && (
                                                <div className="text-[10px] text-red-300 mt-0.5">
                                                    Leader trait is on a non-Leader unit.
                                                </div>
                                            )}
                                        </div>
                                        <button 
                                            onClick={() => removeUpgrade(upgrade.name)}
                                            className="text-stone-500 hover:text-red-400 ml-2 no-print"
                                        >
                                            <Icon name="x" size={14} />
                                        </button>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Spellcaster configuration */}
                        {spellLevel > 0 && (
                            <div className="mt-3 text-xs border border-indigo-700/70 bg-stone-950/60 rounded p-2">
                                <div className="flex items-center justify-between mb-1">
                                    <div className="flex items-center gap-1 font-semibold text-indigo-200">
                                        <Icon name="sparkle" size={14} />
                                        <span>Spellcaster Level {spellLevel}</span>
                                    </div>
                                </div>

                                {/* Colour selection (no-print) */}
                                <div className="no-print mb-2">
                                    <div className="grid grid-cols-2 gap-1">
                                        {SPELL_COLOURS.map(colour => {
                                            const selected = spellConfig.colours.includes(colour);
                                            const disabled = !selected && spellConfig.colours.length >= spellLevel;
                                            return (
                                                <label
                                                    key={colour}
                                                    className={`flex items-center gap-1 text-[11px] cursor-pointer ${disabled ? "opacity-40" : ""}`}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={selected}
                                                        disabled={disabled && !selected}
                                                        onChange={() => handleToggleColour(colour)}
                                                        className="accent-indigo-400"
                                                    />
                                                    <span>{colour} Magic</span>
                                                </label>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-1 text-[10px] text-stone-400">
                                        Pick up to {spellLevel} colours. A colour gives access to all its spells.
                                    </div>
                                </div>

                                {/* Spell list & quick reference (config + prints) */}
                                {spellConfig.colours.length > 0 && (
                                    <div className="space-y-1">
                                        {spellConfig.colours.map(colour => (
                                            <div key={colour} className="mt-1">
                                                <div className="text-[11px] uppercase tracking-wide text-indigo-200">
                                                    {colour} Magic
                                                </div>
                                                <ul className="mt-0.5 space-y-0.5">
                                                    {(SPELLBOOK[colour] || []).map(spell => {
                                                        const isSelected =
                                                            (spellConfig.selectedSpells || []).some(
                                                                s => s.name === spell.name && s.colour === colour
                                                            );
                                                        return (
                                                            <li key={colour + ":" + spell.name} className="flex items-start gap-1">
                                                                <input
                                                                    type="checkbox"
                                                                    className="no-print mt-[2px] accent-indigo-400"
                                                                    checked={!!isSelected}
                                                                    onChange={() => handleToggleSpell(colour, spell.name)}
                                                                />
                                                                <div className="text-[11px] leading-snug">
                                                                    <span className="font-semibold text-indigo-100">
                                                                        {spell.name} ({spell.difficulty})
                                                                    </span>
                                                                    <div className="text-[11px] text-stone-300">
                                                                        <span className="font-semibold">Target:</span> {spell.target}
                                                                    </div>
                                                                    <div className="text-[11px] text-stone-300">
                                                                        <span className="font-semibold">Effect:</span> {spell.effect}
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        );
                                                    })}
                                                </ul>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {selectedSpellObjects.length > 0 && (
                                    <div className="mt-2 text-[10px] text-stone-400">
                                        Tick spells above to include them in this unit’s quick-reference list.
                                        They will print with the card for use at the table.
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Upgrade Selector */}
                        <div className="mt-3 no-print">
                            <select 
                                className="w-full bg-stone-800 text-stone-300 text-sm border border-stone-600 rounded p-2 focus:border-amber-500 outline-none"
                                onChange={addUpgrade}
                                defaultValue=""
                            >
                                <option value="" disabled>+ Add Fantastical Rule / Upgrade</option>
                                {UPGRADES_LIST.map(u => (
                                    <option
                                        key={u.name}
                                        value={u.name}
                                        disabled={(unit.selectedUpgrades || []).some(sel => sel.name === u.name) && !SPELL_UPGRADE_NAMES.includes(u.name)}
                                    >
                                        {u.name} ({u.cost > 0 ? '+' : ''}{u.cost})
                                    </option>
                                ))}
                            </select>
                        </div>

                        {hasLeaderUpgradeOnNonLeader && (
                            <div className="mt-2 text-[11px] text-red-300 no-print">
                                This unit has Leader traits but is not marked as the warband Leader.
                            </div>
                        )}

                        {unit.isLeader && (
                            <div className="mt-2 text-[11px] text-amber-300 uppercase tracking-wide">
                                <Icon name="crown" size={12} className="inline mr-1" />
                                Warband Leader
                            </div>
                        )}

                        {/* Printed spell quick reference (chosen spells only) */}
                        {selectedSpellObjects.length > 0 && (
                            <div className="mt-3 text-[11px] border-t border-stone-700 pt-2">
                                <div className="font-semibold mb-1">
                                    <Icon name="book-open-text" size={12} className="inline mr-1" />
                                    Spell Quick Reference
                                </div>
                                <ul className="space-y-0.5">
                                    {selectedSpellObjects.map((sp, idx) => (
                                        <li key={idx}>
                                            <div>
                                                <span className="font-semibold">
                                                    {sp.name} ({sp.difficulty})
                                                </span>
                                                <span className="text-stone-400"> – {sp.colour} Magic</span>
                                            </div>
                                            <div>
                                                <span className="font-semibold">Target:</span> {sp.target}
                                            </div>
                                            <div>
                                                <span className="font-semibold">Effect:</span> {sp.effect}
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [army, setArmy] = useState(() => {
                try {
                    const saved = localStorage.getItem('dr_army_v1');
                    const parsed = saved ? JSON.parse(saved) : [];
                    return Array.isArray(parsed) ? parsed : [];
                } catch {
                    return [];
                }
            });

            const [armyName, setArmyName] = useState(() => {
                return localStorage.getItem('dr_army_name') || "My Warband";
            });

            const [jsonText, setJsonText] = useState("");

            useEffect(() => {
                localStorage.setItem('dr_army_v1', JSON.stringify(army));
            }, [army]);

            useEffect(() => {
                localStorage.setItem('dr_army_name', armyName);
            }, [armyName]);

            const addUnit = (templateName) => {
                const template = UNIT_TEMPLATES.find(t => t.name === templateName);
                if (!template) return;

                const newUnit = {
                    ...template,
                    id: Date.now() + Math.random(),
                    customName: "",
                    selectedUpgrades: [],
                    isLeader: false,
                    spellConfig: { colours: [], selectedSpells: [] }
                };
                setArmy(prev => [...prev, newUnit]);
            };

            const updateUnit = (id, updatedUnit) => {
                setArmy(prev => prev.map(u => (u.id === id ? updatedUnit : u)));
            };

            const deleteUnit = (id) => {
                setArmy(prev => prev.filter(u => u.id !== id));
            };

            const duplicateUnit = (unit) => {
                const cloned = {
                    ...unit,
                    id: Date.now() + Math.random(),
                    customName: unit.customName ? `${unit.customName} (copy)` : "",
                    isLeader: false
                };
                setArmy(prev => [...prev, cloned]);
            };

            const clearArmy = () => {
                if (army.length === 0) return;
                if (window.confirm("Clear all units from this warband?")) {
                    setArmy([]);
                }
            };

            const setLeader = (id) => {
                setArmy(prev => {
                    const clicked = prev.find(u => u.id === id);
                    const willBeLeader = clicked ? !clicked.isLeader : true;
                    return prev.map(u => ({
                        ...u,
                        isLeader: willBeLeader ? u.id === id : false
                    }));
                });
            };

            const totalPoints = army.reduce((sum, unit) => {
                const unitCost = Math.max(
                    0,
                    unit.cost + (unit.selectedUpgrades || []).reduce((s, u) => s + u.cost, 0)
                );
                return sum + unitCost;
            }, 0);

            const isUnitUndead = (unit) => {
                const baseIsUndead = (unit.rules || []).includes("Undead");
                const upgradeIsUndead = (unit.selectedUpgrades || []).some(u => u.name === "Undead");
                return baseIsUndead || upgradeIsUndead;
            };

            const hasUnstoppable = army.some(
                unit => (unit.selectedUpgrades || []).some(up => up.name === UNSTOPPABLE_NAME)
            );
            const allUndead = army.length > 0 && army.every(isUnitUndead);

            const anyLeaderTraitsOnNonLeader = army.some(
                unit =>
                    !unit.isLeader &&
                    (unit.selectedUpgrades || []).some(up => up.name.indexOf(LEADER_UPGRADE_SUFFIX) !== -1)
            );

            const handleExportJson = () => {
                const data = {
                    armyName,
                    army,
                    version: 4,
                    exportedAt: new Date().toISOString()
                };
                const pretty = JSON.stringify(data, null, 2);
                setJsonText(pretty);
            };

            const handleImportJson = () => {
                try {
                    const parsed = JSON.parse(jsonText);
                    const importedArmyRaw = parsed.army || [];
                    const importedName = parsed.armyName || "Imported Warband";

                    const normalizedArmy = importedArmyRaw.map((unit, idx) => ({
                        ...unit,
                        id: unit.id || (Date.now() + Math.random() + idx),
                        selectedUpgrades: unit.selectedUpgrades || [],
                        isLeader: !!unit.isLeader,
                        rules: unit.rules || [],
                        spellConfig: normalizeSpellConfig(unit.spellConfig)
                    }));

                    setArmy(normalizedArmy);
                    setArmyName(importedName);
                    window.alert("Army imported successfully.");
                } catch (err) {
                    console.error(err);
                    window.alert("Import failed. Please check the JSON is valid and try again.");
                }
            };

            return (
                <div className="min-h-screen bg-neutral-900 text-stone-100">
                    <header className="no-print border-b border-stone-800 bg-black/80 backdrop-blur sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                            <div className="flex items-center gap-3">
                                <Icon name="sword" size={28} className="text-amber-400" />
                                <div>
                                    <h1 className="text-xl md:text-2xl font-bold fantasy-font tracking-wide">
                                        Dragon Rampant Army Builder
                                    </h1>
                                    <p className="text-xs text-stone-400">
                                        Lists are saved locally in this browser (and you can export/import JSON below).
                                    </p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <input
                                    type="text"
                                    value={armyName}
                                    onChange={(e) => setArmyName(e.target.value)}
                                    className="bg-stone-900 border border-stone-700 rounded px-3 py-1 text-sm focus:outline-none focus:border-amber-500 w-full md:w-64"
                                    placeholder="Warband name"
                                />
                                <div className="flex flex-wrap items-center gap-2 text-xs md:text-sm text-stone-300">
                                    <span>
                                        <Icon name="users" size={16} className="inline mr-1" />
                                        {army.length} units
                                    </span>
                                    <span>
                                        <Icon name="coins" size={16} className="inline mr-1 text-amber-300" />
                                        {totalPoints} pts
                                    </span>
                                    <button
                                        onClick={() => window.print()}
                                        className="inline-flex items-center gap-1 px-3 py-1 rounded bg-stone-800 hover:bg-stone-700 text-xs font-semibold"
                                    >
                                        <Icon name="printer" size={14} />
                                        Print
                                    </button>
                                    {army.length > 0 && (
                                        <button
                                            onClick={clearArmy}
                                            className="inline-flex items-center gap-1 px-3 py-1 rounded border border-red-700 text-red-400 hover:bg-red-900/30 text-xs"
                                        >
                                            <Icon name="trash" size={14} />
                                            Clear
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Global warnings */}
                        {(hasUnstoppable && !allUndead) || anyLeaderTraitsOnNonLeader ? (
                            <div className="max-w-6xl mx-auto px-4 pb-3 space-y-1 text-xs no-print">
                                {hasUnstoppable && !allUndead && (
                                    <div className="flex items-start gap-2 text-red-300">
                                        <Icon name="warning-circle" size={14} className="mt-0.5" />
                                        <span>
                                            <strong>Unstoppable March of the Dead (L):</strong> Rules require all units in the
                                            warband to be Undead. At least one unit is not marked as Undead.
                                        </span>
                                    </div>
                                )}
                                {anyLeaderTraitsOnNonLeader && (
                                    <div className="flex items-start gap-2 text-amber-300">
                                        <Icon name="warning" size={14} className="mt-0.5" />
                                        <span>
                                            Some Leader traits are on units that are not marked as the warband Leader. Only the actual Leader
                                            should benefit from Leader traits in the game.
                                        </span>
                                    </div>
                                )}
                            </div>
                        ) : null}
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-4">
                        <div className="grid gap-4 md:grid-cols-[minmax(0,260px),minmax(0,1fr)]">
                            {/* Left panel: add units + JSON tools */}
                            <aside className="no-print">
                                <div className="bg-stone-900 border border-stone-700 rounded-lg p-4 shadow">
                                    <h2 className="text-lg font-semibold fantasy-font mb-3">Add unit</h2>
                                    <p className="text-xs text-stone-400 mb-2">
                                        Choose a template and it will appear on the right.
                                    </p>
                                    <select
                                        className="w-full bg-stone-800 text-stone-100 border border-stone-600 rounded px-2 py-2 text-sm mb-3 focus:outline-none focus:border-amber-500"
                                        onChange={(e) => {
                                            if (e.target.value) {
                                                addUnit(e.target.value);
                                                e.target.value = "";
                                            }
                                        }}
                                        defaultValue=""
                                    >
                                        <option value="" disabled>
                                            Pick a unit type
                                        </option>
                                        {UNIT_TEMPLATES.map((t) => (
                                            <option key={t.name} value={t.name}>
                                                {t.name} ({t.cost} pts)
                                            </option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-stone-500">
                                        Tip: tick <strong>Leader</strong> on the unit that carries your Leader traits.
                                    </p>
                                </div>

                                {/* JSON export/import */}
                                <div className="bg-stone-900 border border-stone-700 rounded-lg p-4 shadow mt-4">
                                    <h2 className="text-sm font-semibold mb-2 flex items-center gap-2">
                                        <Icon name="file-json" size={16} className="text-amber-300" />
                                        Export / Import JSON
                                    </h2>
                                    <p className="text-[11px] text-stone-400 mb-2">
                                        Click <strong>Export</strong> to generate JSON for this warband, then copy and save it somewhere.
                                        Paste JSON back in and click <strong>Import</strong> to load it on another device.
                                    </p>
                                    <textarea
                                        rows="6"
                                        className="w-full bg-stone-950 border border-stone-700 rounded p-2 text-xs text-stone-100 mb-2 font-mono"
                                        placeholder='Click "Export" to generate JSON here, or paste JSON then click "Import".'
                                        value={jsonText}
                                        onChange={(e) => setJsonText(e.target.value)}
                                    ></textarea>
                                    <div className="flex gap-2 justify-end">
                                        <button
                                            type="button"
                                            onClick={handleExportJson}
                                            className="px-3 py-1 rounded bg-stone-800 hover:bg-stone-700 text-xs flex items-center gap-1"
                                        >
                                            <Icon name="export" size={14} />
                                            Export
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleImportJson}
                                            className="px-3 py-1 rounded bg-emerald-800 hover:bg-emerald-700 text-xs flex items-center gap-1"
                                        >
                                            <Icon name="import" size={14} />
                                            Import
                                        </button>
                                    </div>
                                </div>
                            </aside>

                            {/* Right panel: army list */}
                            <section>
                                <h2 className="sr-only">Army list</h2>
                                {army.length === 0 ? (
                                    <div className="border border-dashed border-stone-700 rounded-lg p-8 text-center text-stone-400">
                                        <p className="mb-2 text-sm">No units in this warband yet.</p>
                                        <p className="text-xs">
                                            Use the panel on the left to add your first unit.
                                        </p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {army.map((unit) => (
                                            <UnitCard
                                                key={unit.id}
                                                unit={unit}
                                                onUpdate={updateUnit}
                                                onDelete={deleteUnit}
                                                onDuplicate={duplicateUnit}
                                                onSetLeader={setLeader}
                                            />
                                        ))}
                                    </div>
                                )}
                            </section>
                        </div>
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
